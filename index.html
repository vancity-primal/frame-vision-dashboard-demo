<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slippi Technique Analysis</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÆ Slippi Technique Analysis</h1>
            <div id="summary" class="summary">
                <p>üìÅ Files Processed: <span id="files-processed">Loading...</span></p>
                <p>‚ùå Failed Files: <span id="failed-files">Loading...</span></p>
            </div>
        </header>

        <section class="data-selection">
            <h2>Data Source Selection</h2>
            <div class="data-selection-container">
                <div class="player-data-selector">
                    <h3>Player 1 Data Source</h3>
                    <div class="data-inputs">
                        <div class="folder-input-group">
                            <input type="text" id="player1-folder" placeholder="File path (e.g., BBB#960-FALCO/results.json)" class="folder-input">
                            <button onclick="browseFile(1)" class="browse-button">Browse</button>
                        </div>
                        <select id="player1-code" class="code-input" disabled>
                            <option value="">Select a connect code...</option>
                        </select>
                        <button onclick="loadPlayerData(1)" class="load-button">Load Data</button>
                    </div>
                    <div class="data-status" id="player1-status">No data loaded</div>
                    <input type="file" id="player1-file-browser" accept=".json" style="display: none;" onchange="handleFileSelection(1)">
                </div>
                
                <div class="player-data-selector">
                    <h3>Player 2 Data Source</h3>
                    <div class="data-inputs">
                        <div class="folder-input-group">
                            <input type="text" id="player2-folder" placeholder="File path (e.g., ZAIN#123-MARTH/results.json)" class="folder-input">
                            <button onclick="browseFile(2)" class="browse-button">Browse</button>
                        </div>
                        <select id="player2-code" class="code-input" disabled>
                            <option value="">Select a connect code...</option>
                        </select>
                        <button onclick="loadPlayerData(2)" class="load-button">Load Data</button>
                    </div>
                    <div class="data-status" id="player2-status">No data loaded</div>
                    <input type="file" id="player2-file-browser" accept=".json" style="display: none;" onchange="handleFileSelection(2)">
                </div>
            </div>
        </section>


        <section class="view-navigation">
            <h2>View</h2>
            <div class="view-toggle">
                <button id="movement-view-btn" class="view-btn active" onclick="switchView('movement')">
                    üèÉ Movement Analysis
                </button>
                <button id="attacks-view-btn" class="view-btn" onclick="switchView('attacks')">
                    ‚öîÔ∏è Attacks Analysis
                </button>
                <button id="conversions-view-btn" class="view-btn" onclick="switchView('conversions')">
                    üîÑ Conversions Analysis
                </button>
            </div>
        </section>

        <section class="stage-filter">
            <h2>Stage Filter</h2>
            <div class="stage-filter-info">
                <span id="replay-count-indicator">Replays included: Loading...</span>
            </div>
            <div class="stage-filter-container">
                <div class="stage-filter-buttons">
                    <button id="all-stages-btn" class="stage-btn active" onclick="toggleStageFilter('all')">All Stages</button>
                    <button id="battlefield-btn" class="stage-btn" onclick="toggleStageFilter('battlefield')">Battlefield</button>
                    <button id="dream_land-btn" class="stage-btn" onclick="toggleStageFilter('dream_land')">Dream Land</button>
                    <button id="final_destination-btn" class="stage-btn" onclick="toggleStageFilter('final_destination')">Final Destination</button>
                    <button id="fountain_of_dreams-btn" class="stage-btn" onclick="toggleStageFilter('fountain_of_dreams')">Fountain of Dreams</button>
                    <button id="pokemon_stadium-btn" class="stage-btn" onclick="toggleStageFilter('pokemon_stadium')">Pokemon Stadium</button>
                    <button id="yoshis_story-btn" class="stage-btn" onclick="toggleStageFilter('yoshis_story')">Yoshi's Story</button>
                </div>
            </div>
        </section>

        <main id="movement-container" class="players-comparison">
            <!-- Player movement technique data will be dynamically inserted here in side-by-side layout -->
        </main>

        <main id="attacks-container" class="players-comparison" style="display: none;">
            <!-- Player attack data will be dynamically inserted here in side-by-side layout -->
        </main>

        <main id="conversions-container" class="players-comparison" style="display: none;">
            <!-- Conversion data will be dynamically inserted here -->
        </main>
    </div>

    <script>
        // Stage filtering variables
        const ALL_STAGES = ['battlefield', 'dream_land', 'final_destination', 'fountain_of_dreams', 'pokemon_stadium', 'yoshis_story'];
        let activeStages = [...ALL_STAGES]; // Start with all stages active
        let currentStageFilter = 'all';

        // Load and display data from results.json
        async function loadData() {
            try {
                const response = await fetch('results.json');
                const data = await response.json();
                displayData(data);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('movement-container').innerHTML = 
                    '<div class="error">‚ùå Error loading data. Make sure you have run script.js first!</div>';
            }
        }

        // Load player data from specific folder and connect code
        async function loadPlayerData(playerSlot) {
            const folderInput = document.getElementById(`player${playerSlot}-folder`);
            const codeInput = document.getElementById(`player${playerSlot}-code`);
            const statusElement = document.getElementById(`player${playerSlot}-status`);
            
            const fileName = folderInput.value.trim();
            const connectCode = codeInput.value;
            
            if (!fileName || !connectCode) {
                statusElement.textContent = 'Please upload a file and select a connect code';
                statusElement.className = 'data-status error';
                return;
            }
            
            // Check if file data has been uploaded
            if (!window.uploadedFiles || !window.uploadedFiles[`player${playerSlot}`]) {
                statusElement.textContent = 'Please select a results.json file first';
                statusElement.className = 'data-status error';
                return;
            }
            
            statusElement.textContent = 'Processing...';
            statusElement.className = 'data-status';
            
            try {
                // Use the uploaded file data
                const data = window.uploadedFiles[`player${playerSlot}`];
                
                // Check if the connect code exists in the data
                if (!data.players[connectCode]) {
                    throw new Error(`Connect code "${connectCode}" not found in ${fileName}`);
                }
                
                // Store the player data source
                playerDataSources[`player${playerSlot}`] = {
                    folder: fileName,
                    connectCode: connectCode,
                    playerData: data.players[connectCode],
                    timestamp: data.timestamp
                };
                
                // Update status
                const date = new Date(data.timestamp).toLocaleString();
                statusElement.textContent = `Loaded: ${connectCode} from ${fileName} (${date})`;
                statusElement.className = 'data-status loaded';
                
                // Player name updates removed (stage filtering was removed)
                
                // Update the display if we have data for both players
                updateComparisonDisplay();
                
            } catch (error) {
                console.error('Error loading player data:', error);
                statusElement.textContent = `Error: ${error.message}`;
                statusElement.className = 'data-status error';
            }
        }

        // Trigger folder browser dialog
        // File browser functions
        function browseFile(playerSlot) {
            const fileBrowser = document.getElementById(`player${playerSlot}-file-browser`);
            fileBrowser.click();
        }

        // Handle file selection from browser
        function handleFileSelection(playerSlot) {
            const fileBrowser = document.getElementById(`player${playerSlot}-file-browser`);
            const folderInput = document.getElementById(`player${playerSlot}-folder`);
            const statusElement = document.getElementById(`player${playerSlot}-status`);
            
            if (fileBrowser.files.length > 0) {
                const selectedFile = fileBrowser.files[0];
                
                
                // Read the file content
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Store the data for this player slot
                        if (!window.uploadedFiles) {
                            window.uploadedFiles = {};
                        }
                        window.uploadedFiles[`player${playerSlot}`] = data;
                        
                        // Update the input and status
                        folderInput.value = selectedFile.name;
                        statusElement.textContent = `File loaded: ${selectedFile.name}`;
                        statusElement.className = 'data-status loaded';
                        
                        // Populate connect code dropdown
                        populateConnectCodes(playerSlot, data);
                        
                    } catch (error) {
                        console.error('Error parsing JSON file:', error);
                        statusElement.textContent = `Error: Invalid JSON file`;
                        statusElement.className = 'data-status error';
                    }
                };
                reader.onerror = function() {
                    statusElement.textContent = `Error: Could not read file`;
                    statusElement.className = 'data-status error';
                };
                reader.readAsText(selectedFile);
            }
        }

        let currentData = null;
        let playerDataSources = { player1: null, player2: null };
        let displayModes = {
            player1: {
                basic: 'total',
                platform: 'total',
                platformSequences: 'total',
                aerialResolution: 'total',
                specialResolution: 'breakdown',
                attack: 'breakdown',
                shine: 'total',
                cancel: 'total'
            },
            player2: {
                basic: 'total',
                platform: 'total',
                platformSequences: 'total',
                aerialResolution: 'total',
                specialResolution: 'breakdown',
                attack: 'breakdown',
                shine: 'total',
                cancel: 'total'
            }
        };

        // Stage filtering function
        function toggleStageFilter(stage) {
            // Remove active class from all stage buttons
            document.querySelectorAll('.stage-btn').forEach(btn => btn.classList.remove('active'));
            
            if (stage === 'all') {
                activeStages = [...ALL_STAGES];
                currentStageFilter = 'all';
                document.getElementById('all-stages-btn').classList.add('active');
            } else {
                activeStages = [stage];
                currentStageFilter = stage;
                document.getElementById(`${stage}-btn`).classList.add('active');
            }
            
            // Update replay count indicator
            updateReplayCountIndicator();
            
            // Update displays based on current view
            if (currentView === 'movement') {
                updateMovementDisplay();
            } else if (currentView === 'attacks') {
                updateAttacksDisplay();
            } else if (currentView === 'conversions') {
                updateConversionsDisplay();
            }
        }

        // Update replay count indicator
        function updateReplayCountIndicator() {
            let totalReplays = 0;
            
            // Count replays from current data sources
            if (currentData && currentData.players) {
                // Single file mode - sum matchCount from selected stages across all players
                Object.values(currentData.players).forEach(playerData => {
                    activeStages.forEach(stage => {
                        if (playerData.stages && playerData.stages[stage] && playerData.stages[stage].matchCount) {
                            totalReplays += playerData.stages[stage].matchCount;
                        }
                    });
                });
            } else if (playerDataSources.player1 || playerDataSources.player2) {
                // Comparison mode - get matchCount from selected stages for loaded players
                [1, 2].forEach(slot => {
                    const playerSource = playerDataSources[`player${slot}`];
                    if (playerSource && playerSource.playerData && playerSource.playerData.stages) {
                        let playerReplays = 0;
                        activeStages.forEach(stage => {
                            if (playerSource.playerData.stages[stage] && playerSource.playerData.stages[stage].matchCount) {
                                playerReplays += playerSource.playerData.stages[stage].matchCount;
                            }
                        });
                        // Take the maximum since it's the same games across different players
                        totalReplays = Math.max(totalReplays, playerReplays);
                    }
                });
            }
            
            const indicator = document.getElementById('replay-count-indicator');
            if (indicator) {
                if (totalReplays > 0) {
                    const stageText = currentStageFilter === 'all' ? 'all stages' : activeStages[0].replace('_', ' ');
                    indicator.textContent = `Replays included: ${totalReplays} (${stageText})`;
                } else {
                    indicator.textContent = 'Replays included: 0 (no data loaded)';
                }
            }
        }

        function displayData(data) {
            currentData = data;
            
            // Update summary
            document.getElementById('files-processed').textContent = `${data.filesProcessed}/${data.totalFiles}`;
            document.getElementById('failed-files').textContent = 
                data.failedFiles.length > 0 ? data.failedFiles.join(', ') : 'None';

            // Player name updates removed (stage filtering was removed)


            // Display players with current filters
            updatePlayerDisplay();
            
            // Update replay count indicator
            updateReplayCountIndicator();
        }

        // Update comparison display using separate data sources
        function updateComparisonDisplay() {
            updateComparisonMovementDisplay();
            updateComparisonAttacksDisplay();
        }

        function updateComparisonMovementDisplay() {
            const movementContainer = document.getElementById('movement-container');
            movementContainer.innerHTML = '';

            // Update summary to show comparison mode
            document.getElementById('files-processed').textContent = 'Comparison Mode';
            document.getElementById('failed-files').textContent = 'Loading data from separate sources';

            // Display each player if data is available
            [1, 2].forEach(playerSlot => {
                const playerKey = `player${playerSlot}`;
                const playerSource = playerDataSources[playerKey];
                
                if (playerSource) {
                    // Get filtered stage data
                    const aggregatedData = aggregateStageData(playerSource.playerData.stages, activeStages);
                    
                    // Create movement section
                    const movementSection = createPlayerSection(playerSource.connectCode, aggregatedData, playerSlot);
                    movementContainer.appendChild(movementSection);
                } else {
                    // Show placeholder if no data loaded
                    const movementPlaceholder = document.createElement('section');
                    
                    const placeholderHTML = `
                        <h2>PLAYER ${playerSlot}</h2>
                        <div class="no-data">No data loaded. Use the controls above to load player data.</div>
                    `;
                    
                    movementPlaceholder.className = 'player-section';
                    movementPlaceholder.innerHTML = placeholderHTML;
                    
                    movementContainer.appendChild(movementPlaceholder);
                }
            });
            
            // Setup tabs
            setupPlatformTabs();
            setupDisplayToggleButtons();
            
            // Update replay count indicator
            updateReplayCountIndicator();
        }

        function updateComparisonAttacksDisplay() {
            const attacksContainer = document.getElementById('attacks-container');
            attacksContainer.innerHTML = '';

            // Update summary to show comparison mode
            document.getElementById('files-processed').textContent = 'Comparison Mode';
            document.getElementById('failed-files').textContent = 'Loading data from separate sources';

            // Display each player if data is available
            [1, 2].forEach(playerSlot => {
                const playerKey = `player${playerSlot}`;
                const playerSource = playerDataSources[playerKey];
                
                if (playerSource) {
                    // Get filtered stage data
                    const aggregatedData = aggregateStageData(playerSource.playerData.stages, activeStages);
                    
                    // Create attacks section
                    const attacksSection = createAttackPlayerSection(playerSource.connectCode, aggregatedData, playerSlot);
                    attacksContainer.appendChild(attacksSection);
                } else {
                    // Show placeholder if no data loaded
                    const attacksPlaceholder = document.createElement('section');
                    
                    const placeholderHTML = `
                        <h2>PLAYER ${playerSlot}</h2>
                        <div class="no-data">No data loaded. Use the controls above to load player data.</div>
                    `;
                    
                    attacksPlaceholder.className = 'player-section';
                    attacksPlaceholder.innerHTML = placeholderHTML;
                    
                    attacksContainer.appendChild(attacksPlaceholder);
                }
            });
            
            // Setup tabs
            setupAerialTabs();
            setupSmashTabs();
            setupLaserTabs();
            setupPhantasmTabs();
            setupFirefoxTabs();
            setupDisplayToggleButtons();
            
            // Update replay count indicator
            updateReplayCountIndicator();
        }


        function updatePlayerDisplay() {
            if (!currentData) return;
            updateMovementDisplay();
            updateAttacksDisplay();
        }

        function updateMovementDisplay() {
            if (!currentData && !playerDataSources.player1 && !playerDataSources.player2) return;
            
            const movementContainer = document.getElementById('movement-container');
            movementContainer.innerHTML = '';

            // Use comparison mode if available, otherwise use single file mode
            if (playerDataSources.player1 || playerDataSources.player2) {
                updateComparisonMovementDisplay();
            } else {
                const playerNames = Object.keys(currentData.players);
                
                playerNames.forEach((playerConnectCode, index) => {
                    const playerData = currentData.players[playerConnectCode];
                    
                    // Get filtered stage data
                    const aggregatedData = aggregateStageData(playerData.stages, activeStages);
                    
                    // Create movement section
                    const movementSection = createPlayerSection(playerConnectCode, aggregatedData, index + 1);
                    movementContainer.appendChild(movementSection);
                });
                
                // Setup tabs
                setupPlatformTabs();
                setupDisplayToggleButtons();
            }
        }

        function updateAttacksDisplay() {
            if (!currentData && !playerDataSources.player1 && !playerDataSources.player2) return;
            
            const attacksContainer = document.getElementById('attacks-container');
            attacksContainer.innerHTML = '';

            // Use comparison mode if available, otherwise use single file mode
            if (playerDataSources.player1 || playerDataSources.player2) {
                updateComparisonAttacksDisplay();
            } else {
                const playerNames = Object.keys(currentData.players);
                
                playerNames.forEach((playerConnectCode, index) => {
                    const playerData = currentData.players[playerConnectCode];
                    
                    // Get filtered stage data
                    const aggregatedData = aggregateStageData(playerData.stages, activeStages);
                    
                    // Create attacks section
                    const attacksSection = createAttackPlayerSection(playerConnectCode, aggregatedData, index + 1);
                    attacksContainer.appendChild(attacksSection);
                });
                
                // Setup tabs
                setupAerialTabs();
                setupSmashTabs();
                setupLaserTabs();
                setupPhantasmTabs();
                setupFirefoxTabs();
                setupDisplayToggleButtons();
            }
        }

        function aggregateStageData(stageData, selectedStages) {
            // If selectedStages is provided, use it; otherwise use activeStages
            const stagesToAggregate = selectedStages || activeStages;
            
            // Initialize aggregated data structure
            const aggregated = {
                matchCount: 0,
                wavedashCount: 0,
                wavelandCount: 0,
                lCancelCount: 0,
                dashDanceCount: 0,
                ledgegrabCount: 0,
                rollCount: 0,
                airDodgeCount: 0,
                spotDodgeCount: 0,
                shieldDropCount: 0,
                shieldDropEvents: {},
                platformDropCount: 0,
                platformDropEvents: {},
                runOffCount: 0,
                runOffEvents: {},
                wavelandOffCount: 0,
                wavelandOffEvents: {},
                groundAttackEvents: {},
                smashAttackEvents: {},
                aerialAttackEvents: {},
                phantasmEvents: {},
                phantasmSequences: {},
                shineSequences: {},
                shineEvents: {},
                lCancelEvents: {},
                laserEvents: {},
                firefoxEvents: {},
                shineWavedashCount: {
                    framePerfect: 0,
                    framePerfectTurn: 0,
                    regular: 0,
                    regularTurn: 0,
                    total: 0
                },
                shineWavelandCount: {
                    regular: 0,
                    turn: 0,
                    total: 0
                },
                shineGrabCount: {
                    framePerfect: 0,
                    framePerfectTurn: 0,
                    regular: 0,
                    regularTurn: 0,
                    total: 0
                },
                shineTurnaroundFirefoxLedgeGrabCount: 0,
                edgeCancelCount: {
                    dair: 0,
                    uair: 0,
                    bair: 0,
                    fair: 0,
                    nair: 0,
                    total: 0
                },
                teeterCancelCount: {
                    dair: 0,
                    uair: 0,
                    bair: 0,
                    fair: 0,
                    nair: 0,
                    total: 0
                },
                autoCancelCount: {
                    dair: 0,
                    uair: 0,
                    bair: 0,
                    fair: 0,
                    nair: 0,
                    total: 0
                },
                platformCancelCount: {
                    dair: 0,
                    uair: 0,
                    bair: 0,
                    fair: 0,
                    nair: 0,
                    total: 0
                },
                noImpactLandingCount: 0,
                attackCount: {
                    jab1: 0, jab2: 0, jab3: 0, jabm: 0, dash: 0,
                    ftilt: 0, utilt: 0, dtilt: 0,
                    fsmash: 0, usmash: 0, dsmash: 0,
                    nair: 0, fair: 0, bair: 0, uair: 0, dair: 0
                },
                aerialExecutionCount: {
                    nair: { cStick: 0, aDirection: 0, total: 0 },
                    fair: { cStick: 0, aDirection: 0, total: 0 },
                    bair: { cStick: 0, aDirection: 0, total: 0 },
                    uair: { cStick: 0, aDirection: 0, total: 0 },
                    dair: { cStick: 0, aDirection: 0, total: 0 }
                },
                smashExecutionCount: {
                    fsmash: { cStick: 0, aDirection: 0, total: 0 },
                    usmash: { cStick: 0, aDirection: 0, total: 0 },
                    dsmash: { cStick: 0, aDirection: 0, total: 0 }
                },
                attacksInfo: {},
                specials: {},
                combos: {
                    totalCombos: 0,
                    killCombos: 0,
                    totalDamage: 0,
                    longestCombo: 0,
                    highestDamageCombo: 0,
                    comboList: []
                }
            };

            // Aggregate data from selected stages
            stagesToAggregate.forEach(stage => {
                if (stageData[stage]) {
                    const stageStats = stageData[stage];
                    
                    // Aggregate simple counts
                    aggregated.matchCount += stageStats.matchCount || 0;
                    aggregated.wavedashCount += stageStats.wavedashCount || 0;
                    aggregated.wavelandCount += stageStats.wavelandCount || 0;
                    aggregated.lCancelCount += stageStats.lCancelCount || 0;
                    aggregated.dashDanceCount += stageStats.dashDanceCount || 0;
                    aggregated.ledgegrabCount += stageStats.ledgegrabCount || 0;
                    aggregated.rollCount += stageStats.rollCount || 0;
                    aggregated.airDodgeCount += stageStats.airDodgeCount || 0;
                    aggregated.spotDodgeCount += stageStats.spotDodgeCount || 0;
                    aggregated.shieldDropCount += stageStats.shieldDropCount || 0;
                    aggregated.platformDropCount += stageStats.platformDropCount || 0;
                    aggregated.runOffCount += stageStats.runOffCount || 0;
                    aggregated.wavelandOffCount += stageStats.wavelandOffCount || 0;
                    aggregated.shineTurnaroundFirefoxLedgeGrabCount += stageStats.shineTurnaroundFirefoxLedgeGrabCount || 0;
                    
                    // Aggregate nested shine objects
                    if (stageStats.shineWavedashCount) {
                        aggregated.shineWavedashCount.framePerfect += stageStats.shineWavedashCount.framePerfect || 0;
                        aggregated.shineWavedashCount.framePerfectTurn += stageStats.shineWavedashCount.framePerfectTurn || 0;
                        aggregated.shineWavedashCount.regular += stageStats.shineWavedashCount.regular || 0;
                        aggregated.shineWavedashCount.regularTurn += stageStats.shineWavedashCount.regularTurn || 0;
                        aggregated.shineWavedashCount.total += stageStats.shineWavedashCount.total || 0;
                    }
                    
                    if (stageStats.shineWavelandCount) {
                        aggregated.shineWavelandCount.regular += stageStats.shineWavelandCount.regular || 0;
                        aggregated.shineWavelandCount.turn += stageStats.shineWavelandCount.turn || 0;
                        aggregated.shineWavelandCount.total += stageStats.shineWavelandCount.total || 0;
                    }
                    
                    if (stageStats.shineGrabCount) {
                        aggregated.shineGrabCount.framePerfect += stageStats.shineGrabCount.framePerfect || 0;
                        aggregated.shineGrabCount.framePerfectTurn += stageStats.shineGrabCount.framePerfectTurn || 0;
                        aggregated.shineGrabCount.regular += stageStats.shineGrabCount.regular || 0;
                        aggregated.shineGrabCount.regularTurn += stageStats.shineGrabCount.regularTurn || 0;
                        aggregated.shineGrabCount.total += stageStats.shineGrabCount.total || 0;
                    }
                    
                    // Aggregate cancel count objects
                    if (stageStats.edgeCancelCount) {
                        aggregated.edgeCancelCount.dair += stageStats.edgeCancelCount.dair || 0;
                        aggregated.edgeCancelCount.uair += stageStats.edgeCancelCount.uair || 0;
                        aggregated.edgeCancelCount.bair += stageStats.edgeCancelCount.bair || 0;
                        aggregated.edgeCancelCount.fair += stageStats.edgeCancelCount.fair || 0;
                        aggregated.edgeCancelCount.nair += stageStats.edgeCancelCount.nair || 0;
                        aggregated.edgeCancelCount.total += stageStats.edgeCancelCount.total || 0;
                    }
                    
                    if (stageStats.teeterCancelCount) {
                        aggregated.teeterCancelCount.dair += stageStats.teeterCancelCount.dair || 0;
                        aggregated.teeterCancelCount.uair += stageStats.teeterCancelCount.uair || 0;
                        aggregated.teeterCancelCount.bair += stageStats.teeterCancelCount.bair || 0;
                        aggregated.teeterCancelCount.fair += stageStats.teeterCancelCount.fair || 0;
                        aggregated.teeterCancelCount.nair += stageStats.teeterCancelCount.nair || 0;
                        aggregated.teeterCancelCount.total += stageStats.teeterCancelCount.total || 0;
                    }
                    
                    if (stageStats.autoCancelCount) {
                        aggregated.autoCancelCount.dair += stageStats.autoCancelCount.dair || 0;
                        aggregated.autoCancelCount.uair += stageStats.autoCancelCount.uair || 0;
                        aggregated.autoCancelCount.bair += stageStats.autoCancelCount.bair || 0;
                        aggregated.autoCancelCount.fair += stageStats.autoCancelCount.fair || 0;
                        aggregated.autoCancelCount.nair += stageStats.autoCancelCount.nair || 0;
                        aggregated.autoCancelCount.total += stageStats.autoCancelCount.total || 0;
                    }
                    
                    if (stageStats.platformCancelCount) {
                        aggregated.platformCancelCount.dair += stageStats.platformCancelCount.dair || 0;
                        aggregated.platformCancelCount.uair += stageStats.platformCancelCount.uair || 0;
                        aggregated.platformCancelCount.bair += stageStats.platformCancelCount.bair || 0;
                        aggregated.platformCancelCount.fair += stageStats.platformCancelCount.fair || 0;
                        aggregated.platformCancelCount.nair += stageStats.platformCancelCount.nair || 0;
                        aggregated.platformCancelCount.total += stageStats.platformCancelCount.total || 0;
                    }
                    
                    aggregated.noImpactLandingCount += stageStats.noImpactLandingCount || 0;
                    
                    // Aggregate attack count
                    if (stageStats.attackCount) {
                        Object.keys(aggregated.attackCount).forEach(attack => {
                            aggregated.attackCount[attack] += stageStats.attackCount[attack] || 0;
                        });
                    }
                    
                    // Aggregate aerial execution count
                    if (stageStats.aerialExecutionCount) {
                        Object.keys(aggregated.aerialExecutionCount).forEach(aerial => {
                            if (stageStats.aerialExecutionCount[aerial]) {
                                aggregated.aerialExecutionCount[aerial].cStick += stageStats.aerialExecutionCount[aerial].cStick || 0;
                                aggregated.aerialExecutionCount[aerial].aDirection += stageStats.aerialExecutionCount[aerial].aDirection || 0;
                                aggregated.aerialExecutionCount[aerial].total += stageStats.aerialExecutionCount[aerial].total || 0;
                            }
                        });
                    }
                    
                    // Aggregate smash execution count
                    if (stageStats.smashExecutionCount) {
                        Object.keys(aggregated.smashExecutionCount).forEach(smash => {
                            if (stageStats.smashExecutionCount[smash]) {
                                aggregated.smashExecutionCount[smash].cStick += stageStats.smashExecutionCount[smash].cStick || 0;
                                aggregated.smashExecutionCount[smash].aDirection += stageStats.smashExecutionCount[smash].aDirection || 0;
                                aggregated.smashExecutionCount[smash].total += stageStats.smashExecutionCount[smash].total || 0;
                            }
                        });
                    }
                    
                    // Aggregate events
                    if (stageStats.shieldDropEvents) {
                        Object.assign(aggregated.shieldDropEvents, stageStats.shieldDropEvents);
                    }
                    if (stageStats.platformDropEvents) {
                        Object.assign(aggregated.platformDropEvents, stageStats.platformDropEvents);
                    }
                    if (stageStats.runOffEvents) {
                        Object.assign(aggregated.runOffEvents, stageStats.runOffEvents);
                    }
                    if (stageStats.phantasmEvents) {
                        Object.assign(aggregated.phantasmEvents, stageStats.phantasmEvents);
                    }
                    if (stageStats.phantasmSequences) {
                        Object.assign(aggregated.phantasmSequences, stageStats.phantasmSequences);
                    }
                    if (stageStats.shineSequences) {
                        Object.assign(aggregated.shineSequences, stageStats.shineSequences);
                    }
                    if (stageStats.shineEvents) {
                        Object.assign(aggregated.shineEvents, stageStats.shineEvents);
                    }
                    if (stageStats.lCancelEvents) {
                        Object.assign(aggregated.lCancelEvents, stageStats.lCancelEvents);
                    }
                    if (stageStats.wavelandOffEvents) {
                        Object.assign(aggregated.wavelandOffEvents, stageStats.wavelandOffEvents);
                    }
                    if (stageStats.groundAttackEvents) {
                        Object.assign(aggregated.groundAttackEvents, stageStats.groundAttackEvents);
                    }
                    if (stageStats.smashAttackEvents) {
                        Object.assign(aggregated.smashAttackEvents, stageStats.smashAttackEvents);
                    }
                    if (stageStats.aerialAttackEvents) {
                        Object.assign(aggregated.aerialAttackEvents, stageStats.aerialAttackEvents);
                    }
                    if (stageStats.laserEvents) {
                        Object.assign(aggregated.laserEvents, stageStats.laserEvents);
                    }
                    if (stageStats.firefoxEvents) {
                        Object.assign(aggregated.firefoxEvents, stageStats.firefoxEvents);
                    }
                    
                    // Aggregate attacks info
                    if (stageStats.attacksInfo) {
                        Object.keys(stageStats.attacksInfo).forEach(attackType => {
                            if (!aggregated.attacksInfo[attackType]) {
                                aggregated.attacksInfo[attackType] = {};
                            }
                            Object.keys(stageStats.attacksInfo[attackType]).forEach(stat => {
                                if (!aggregated.attacksInfo[attackType][stat]) {
                                    aggregated.attacksInfo[attackType][stat] = 0;
                                }
                                aggregated.attacksInfo[attackType][stat] += stageStats.attacksInfo[attackType][stat] || 0;
                            });
                        });
                    }
                    
                    // Aggregate specials
                    if (stageStats.specials) {
                        Object.keys(stageStats.specials).forEach(special => {
                            if (!aggregated.specials[special]) {
                                aggregated.specials[special] = {};
                            }
                            Object.keys(stageStats.specials[special]).forEach(stat => {
                                if (!aggregated.specials[special][stat]) {
                                    aggregated.specials[special][stat] = 0;
                                }
                                aggregated.specials[special][stat] += stageStats.specials[special][stat] || 0;
                            });
                        });
                    }
                    
                    // Aggregate combo data
                    if (stageStats.combos) {
                        aggregated.combos.totalCombos += stageStats.combos.totalCombos || 0;
                        aggregated.combos.killCombos += stageStats.combos.killCombos || 0;
                        aggregated.combos.totalDamage += stageStats.combos.totalDamage || 0;
                        
                        if ((stageStats.combos.longestCombo || 0) > aggregated.combos.longestCombo) {
                            aggregated.combos.longestCombo = stageStats.combos.longestCombo;
                        }
                        if ((stageStats.combos.highestDamageCombo || 0) > aggregated.combos.highestDamageCombo) {
                            aggregated.combos.highestDamageCombo = stageStats.combos.highestDamageCombo;
                        }
                        
                        if (stageStats.combos.comboList && Array.isArray(stageStats.combos.comboList)) {
                            aggregated.combos.comboList.push(...stageStats.combos.comboList);
                        }
                    }
                }
            });
            
            return aggregated;
        }

        function createPlayerSection(playerConnectCode, totals, playerSlot) {
            const section = document.createElement('section');
            section.className = 'player-section';
            
            section.innerHTML = `
                <h2>${playerConnectCode.toUpperCase()}</h2>
                
                <div class="technique-categories">
                    ${createBasicTechniques(totals, playerSlot)}
                    ${createPlatformMovement(totals, playerSlot)}
                    ${createShineMovement(totals, playerSlot)}
                    ${createCancelTechniques(totals, playerSlot)}
                </div>
            `;
            
            // Add event listeners for collapsible categories
            section.addEventListener('click', handleCategoryToggle);
            
            return section;
        }

        function createAttackPlayerSection(playerConnectCode, totals, playerSlot) {
            const section = document.createElement('section');
            section.className = 'player-section';
            
            section.innerHTML = `
                <h2>${playerConnectCode.toUpperCase()}</h2>
                
                <div class="technique-categories">
                    ${createAttackStatistics(totals, playerSlot)}
                    ${createSpecialsStatistics(totals, playerSlot)}
                </div>
            `;
            
            // Add event listeners for collapsible categories
            section.addEventListener('click', handleCategoryToggle);
            
            return section;
        }

        function createDisplayToggles(playerSlot, categoryId) {
            // Attack category has special total/breakdown/per-game options
            if (categoryId === 'attack') {
                return `
                    <div class="display-toggles">
                        <div class="toggle-button ${displayModes[`player${playerSlot}`][categoryId] === 'breakdown' ? 'active' : ''}" 
                             onclick="setDisplayMode(${playerSlot}, '${categoryId}', 'breakdown')">Breakdown</div>
                        <div class="toggle-button ${displayModes[`player${playerSlot}`][categoryId] === 'per-game' ? 'active' : ''}" 
                             onclick="setDisplayMode(${playerSlot}, '${categoryId}', 'per-game')">Per Game</div>
                        <div class="toggle-button ${displayModes[`player${playerSlot}`][categoryId] === 'total' ? 'active' : ''}" 
                             onclick="setDisplayMode(${playerSlot}, '${categoryId}', 'total')">Total</div>
                    </div>
                `;
            }
            
            // Categories that don't support percentage view
            const noPercentageCategories = ['basic', 'platform'];
            
            if (noPercentageCategories.includes(categoryId)) {
                return `
                    <div class="display-toggles">
                        <div class="toggle-button ${displayModes[`player${playerSlot}`][categoryId] === 'total' ? 'active' : ''}" 
                             onclick="setDisplayMode(${playerSlot}, '${categoryId}', 'total')">Total</div>
                        <div class="toggle-button ${displayModes[`player${playerSlot}`][categoryId] === 'per-game' ? 'active' : ''}" 
                             onclick="setDisplayMode(${playerSlot}, '${categoryId}', 'per-game')">Per Game</div>
                    </div>
                `;
            }
            
            return `
                <div class="display-toggles">
                    <div class="toggle-button ${displayModes[`player${playerSlot}`][categoryId] === 'total' ? 'active' : ''}" 
                         onclick="setDisplayMode(${playerSlot}, '${categoryId}', 'total')">Total</div>
                    <div class="toggle-button ${displayModes[`player${playerSlot}`][categoryId] === 'per-game' ? 'active' : ''}" 
                         onclick="setDisplayMode(${playerSlot}, '${categoryId}', 'per-game')">Per Game</div>
                    <div class="toggle-button ${displayModes[`player${playerSlot}`][categoryId] === 'percentage' ? 'active' : ''}" 
                         onclick="setDisplayMode(${playerSlot}, '${categoryId}', 'percentage')">%</div>
                </div>
            `;
        }

        function createPlatformSequenceToggles(playerSlot) {
            return `
                <div class="display-toggles platform-sequence-toggles">
                    <div class="toggle-button ${displayModes[`player${playerSlot}`]['platformSequences'] === 'total' ? 'active' : ''}" 
                         onclick="setDisplayMode(${playerSlot}, 'platformSequences', 'total')">Total</div>
                    <div class="toggle-button ${displayModes[`player${playerSlot}`]['platformSequences'] === 'percentage' ? 'active' : ''}" 
                         onclick="setDisplayMode(${playerSlot}, 'platformSequences', 'percentage')">%</div>
                </div>
            `;
        }

        function createAerialResolutionToggles(playerSlot) {
            return `
                <div class="display-toggles aerial-resolution-toggles">
                    <div class="toggle-button ${displayModes[`player${playerSlot}`]['aerialResolution'] === 'total' ? 'active' : ''}" 
                         onclick="setDisplayMode(${playerSlot}, 'aerialResolution', 'total')">Total</div>
                    <div class="toggle-button ${displayModes[`player${playerSlot}`]['aerialResolution'] === 'percentage' ? 'active' : ''}" 
                         onclick="setDisplayMode(${playerSlot}, 'aerialResolution', 'percentage')">%</div>
                </div>
            `;
        }

        function createAerialResolutionPanel(aerialType, totals, playerSlot, isActive) {
            // Handle both old array format and new object format
            let aerialEvents;
            if (Array.isArray(totals.aerialAttackEvents)) {
                aerialEvents = totals.aerialAttackEvents;
            } else if (totals.aerialAttackEvents && typeof totals.aerialAttackEvents === 'object') {
                aerialEvents = Object.values(totals.aerialAttackEvents).flat();
            } else {
                return '';
            }

            const mode = displayModes[`player${playerSlot}`]['aerialResolution'];
            const gamesPlayed = playerDataSources[`player${playerSlot}`]?.playerData?.gamesPlayed || 1;
            
            // Calculate total resolutions for percentage calculations from events
            const groundResolutionTotal = countAerialResolutionFromEvents(aerialEvents, aerialType, 'lCancelSuccess') + 
                                        countAerialResolutionFromEvents(aerialEvents, aerialType, 'lCancelFail') + 
                                        countAerialResolutionFromEvents(aerialEvents, aerialType, 'edgeCancel') + 
                                        countAerialResolutionFromEvents(aerialEvents, aerialType, 'teeterCancel') + 
                                        countAerialResolutionFromEvents(aerialEvents, aerialType, 'autoCancel') + 
                                        countAerialResolutionFromEvents(aerialEvents, aerialType, 'platformCancel');
            
            const otherResolutionTotal = countAerialResolutionFromEvents(aerialEvents, aerialType, 'aerialTransition') + 
                                       countAerialResolutionFromEvents(aerialEvents, aerialType, 'recoveryTransition') + 
                                       countAerialResolutionFromEvents(aerialEvents, aerialType, 'hitOut') + 
                                       countAerialResolutionFromEvents(aerialEvents, aerialType, 'death') + 
                                       countAerialResolutionFromEvents(aerialEvents, aerialType, 'other');
            
            const totalResolutions = groundResolutionTotal + otherResolutionTotal;
            const categoryTotals = { total: totalResolutions };

            return `
                <div class="aerial-panel ${isActive ? 'active' : ''}" data-aerial="${aerialType}">
                    <div class="aerial-resolution-header">
                        <div class="aerial-resolution-spacer"></div>
                        ${createAerialResolutionToggles(playerSlot)}
                    </div>
                    <div class="resolution-breakdown">
                        <div class="resolution-category">
                            <h5>Ground Resolutions - ${formatValue(groundResolutionTotal, mode, gamesPlayed, categoryTotals)}</h5>
                            <div class="technique-grid">
                                <div class="technique-item${countAerialResolutionFromEvents(aerialEvents, aerialType, 'lCancelSuccess') === 0 ? ' zero-value' : ''}">L-Cancel Success: <span>${formatValue(countAerialResolutionFromEvents(aerialEvents, aerialType, 'lCancelSuccess'), mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item${countAerialResolutionFromEvents(aerialEvents, aerialType, 'lCancelFail') === 0 ? ' zero-value' : ''}">L-Cancel Fail: <span>${formatValue(countAerialResolutionFromEvents(aerialEvents, aerialType, 'lCancelFail'), mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item${countAerialResolutionFromEvents(aerialEvents, aerialType, 'edgeCancel') === 0 ? ' zero-value' : ''}">Edge Cancel: <span>${formatValue(countAerialResolutionFromEvents(aerialEvents, aerialType, 'edgeCancel'), mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item${countAerialResolutionFromEvents(aerialEvents, aerialType, 'teeterCancel') === 0 ? ' zero-value' : ''}">Teeter Cancel: <span>${formatValue(countAerialResolutionFromEvents(aerialEvents, aerialType, 'teeterCancel'), mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item${countAerialResolutionFromEvents(aerialEvents, aerialType, 'autoCancel') === 0 ? ' zero-value' : ''}">Auto Cancel: <span>${formatValue(countAerialResolutionFromEvents(aerialEvents, aerialType, 'autoCancel'), mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item${countAerialResolutionFromEvents(aerialEvents, aerialType, 'platformCancel') === 0 ? ' zero-value' : ''}">Platform Cancel: <span>${formatValue(countAerialResolutionFromEvents(aerialEvents, aerialType, 'platformCancel'), mode, gamesPlayed, categoryTotals)}</span></div>
                            </div>
                        </div>
                        <div class="resolution-category">
                            <h5>Other Resolutions - ${formatValue(otherResolutionTotal, mode, gamesPlayed, categoryTotals)}</h5>
                            <div class="technique-grid">
                                <div class="technique-item${countAerialResolutionFromEvents(aerialEvents, aerialType, 'aerialTransition') === 0 ? ' zero-value' : ''}">Aerial Transition: <span>${formatValue(countAerialResolutionFromEvents(aerialEvents, aerialType, 'aerialTransition'), mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item${countAerialResolutionFromEvents(aerialEvents, aerialType, 'recoveryTransition') === 0 ? ' zero-value' : ''}">Recovery Transition: <span>${formatValue(countAerialResolutionFromEvents(aerialEvents, aerialType, 'recoveryTransition'), mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item${countAerialResolutionFromEvents(aerialEvents, aerialType, 'hitOut') === 0 ? ' zero-value' : ''}">Hit Out: <span>${formatValue(countAerialResolutionFromEvents(aerialEvents, aerialType, 'hitOut'), mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item${countAerialResolutionFromEvents(aerialEvents, aerialType, 'death') === 0 ? ' zero-value' : ''}">Death: <span>${formatValue(countAerialResolutionFromEvents(aerialEvents, aerialType, 'death'), mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item${countAerialResolutionFromEvents(aerialEvents, aerialType, 'other') === 0 ? ' zero-value' : ''}">Other: <span>${formatValue(countAerialResolutionFromEvents(aerialEvents, aerialType, 'other'), mode, gamesPlayed, categoryTotals)}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        function setDisplayMode(playerSlot, categoryId, mode) {
            console.log(`setDisplayMode called: player${playerSlot}, ${categoryId}, ${mode}`);
            displayModes[`player${playerSlot}`][categoryId] = mode;
            
            // Call the appropriate update function based on current view
            if (currentView === 'attacks') {
                // Only update the specific category that changed, don't regenerate entire view
                updateSpecificCategory(playerSlot, categoryId);
            } else if (currentView === 'conversions') {
                updateConversionsDisplay();
            } else {
                updateComparisonDisplay();
            }
        }

        function updateSpecificCategory(playerSlot, categoryId) {
            const playerKey = `player${playerSlot}`;
            const playerSource = playerDataSources[playerKey];
            
            if (!playerSource || !playerSource.playerData) {
                return;
            }
            
            const aggregatedData = aggregateStageData(playerSource.playerData.stages, null);
            
            // Find the player section in the attacks container
            const attacksContainer = document.getElementById('attacks-container');
            const playerSections = attacksContainer.querySelectorAll('.player-section');
            const playerSection = playerSections[playerSlot - 1]; // playerSlot is 1-based
            
            if (!playerSection) {
                // If player section doesn't exist, fall back to full update
                updateAttacksDisplay();
                return;
            }
            
            // Update only the specific category based on categoryId
            if (categoryId === 'specialResolution') {
                // Find and update the Special Statistics category
                let specialsCategory = null;
                const categories = playerSection.querySelectorAll('.category');
                categories.forEach(category => {
                    const h3 = category.querySelector('h3');
                    if (h3 && h3.textContent.includes('Specials Statistics')) {
                        specialsCategory = category;
                    }
                });
                
                if (specialsCategory) {
                    // Replace the category content with updated version
                    const newSpecialsHTML = createSpecialsStatistics(aggregatedData, playerSlot);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = newSpecialsHTML;
                    const newCategory = tempDiv.firstElementChild;
                    
                    // Preserve collapsed state
                    if (specialsCategory.classList.contains('collapsed')) {
                        newCategory.classList.add('collapsed');
                        const icon = newCategory.querySelector('.expand-icon');
                        if (icon) icon.textContent = '‚ñ∂';
                    }
                    
                    specialsCategory.replaceWith(newCategory);
                    
                    // Re-setup event handlers for the new content
                    setupPhantasmTabs();
                    setupFirefoxTabs();
                    setupDisplayToggleButtons();
                }
            } else if (categoryId === 'attack') {
                // Find and update the Attack Statistics category
                let attackCategory = null;
                const categories = playerSection.querySelectorAll('.category');
                categories.forEach(category => {
                    const h3 = category.querySelector('h3');
                    if (h3 && h3.textContent.includes('Attack Statistics')) {
                        attackCategory = category;
                    }
                });
                
                if (attackCategory) {
                    const newAttackHTML = createAttackStatistics(aggregatedData, playerSlot);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = newAttackHTML;
                    const newCategory = tempDiv.firstElementChild;
                    
                    // Preserve collapsed state
                    if (attackCategory.classList.contains('collapsed')) {
                        newCategory.classList.add('collapsed');
                        const icon = newCategory.querySelector('.expand-icon');
                        if (icon) icon.textContent = '‚ñ∂';
                    }
                    
                    attackCategory.replaceWith(newCategory);
                    
                    // Re-setup event handlers for the new content
                    setupAerialTabs();
                    setupSmashTabs();
                    setupDisplayToggleButtons();
                }
            }
            // Add other categories as needed
        }

        // Helper function to count ground attack events by type with hit/block/whiff breakdown
        function countGroundAttackEvents(events, attackType = null) {
            if (!events || !Array.isArray(events)) return attackType ? { hit: 0, block: 0, whiff: 0, total: 0 } : 0;
            
            if (attackType) {
                const filteredEvents = events.filter(event => event.resolution && event.resolution.subtype === attackType);
                const breakdown = { hit: 0, block: 0, whiff: 0, total: filteredEvents.length };
                
                filteredEvents.forEach(event => {
                    const contactState = event.contactState;
                    if (contactState === 'hit') {
                        breakdown.hit++;
                    } else if (contactState === 'blocked') {
                        breakdown.block++;
                    } else if (contactState === 'whiff') {
                        breakdown.whiff++;
                    }
                });
                
                return breakdown;
            }
            return events.length;
        }

        // Helper function to count smash attack events by type with hit/block/whiff breakdown
        function countSmashAttackEvents(events, attackType = null) {
            if (!events || !Array.isArray(events)) return attackType ? { hit: 0, block: 0, whiff: 0, total: 0 } : 0;
            
            if (attackType) {
                const filteredEvents = events.filter(event => event.resolution && event.resolution.subtype === attackType);
                const breakdown = { hit: 0, block: 0, whiff: 0, total: filteredEvents.length };
                
                filteredEvents.forEach(event => {
                    const contactState = event.contactState;
                    if (contactState === 'hit') {
                        breakdown.hit++;
                    } else if (contactState === 'blocked') {
                        breakdown.block++;
                    } else if (contactState === 'whiff') {
                        breakdown.whiff++;
                    }
                });
                
                return breakdown;
            }
            return events.length;
        }

        // Helper function to count aerial attack events by type with hit/block/whiff breakdown
        function countAerialAttackEvents(events, attackType = null) {
            if (!events || !Array.isArray(events)) return attackType ? { hit: 0, block: 0, whiff: 0, total: 0 } : 0;
            
            if (attackType) {
                const filteredEvents = events.filter(event => event.resolution && event.resolution.subtype === attackType);
                const breakdown = { hit: 0, block: 0, whiff: 0, total: filteredEvents.length };
                
                filteredEvents.forEach(event => {
                    const contactState = event.contactState;
                    if (contactState === 'hit') {
                        breakdown.hit++;
                    } else if (contactState === 'blocked') {
                        breakdown.block++;
                    } else if (contactState === 'whiff') {
                        breakdown.whiff++;
                    }
                });
                
                return breakdown;
            }
            return events.length;
        }

        // Helper function to count aerial execution methods from events
        function countAerialExecutionFromEvents(events, attackType, executionMethod) {
            if (!events || !Array.isArray(events)) return 0;
            return events.filter(event => 
                event.resolution && 
                event.resolution.subtype === attackType && 
                event.resolution.executionMethod === executionMethod
            ).length;
        }

        // Helper function to generate tooltip text for aerial execution methods  
        function generateAerialExecutionTooltip(totals, aerialType) {
            // Use events data to match the display counts
            const aerialEvents = Array.isArray(totals.aerialAttackEvents) 
                ? totals.aerialAttackEvents 
                : Object.values(totals.aerialAttackEvents || {}).flat();
            
            const cStickEvents = aerialEvents.filter(event => 
                event.resolution?.subtype === aerialType && 
                event.resolution?.executionMethod === 'cStick'
            ).length;
            
            const aDirectionEvents = aerialEvents.filter(event => 
                event.resolution?.subtype === aerialType && 
                event.resolution?.executionMethod === 'aDirection'
            ).length;
            
            const totalEvents = aerialEvents.filter(event => 
                event.resolution?.subtype === aerialType
            ).length;
            
            return `C-Stick/A+Dir: ${cStickEvents}/${aDirectionEvents} = ${cStickEvents + aDirectionEvents} (Events: ${totalEvents})`;
        }

        // Helper function to generate tooltip text for smash execution methods
        function generateSmashExecutionTooltip(smash) {
            const cStick = smash.cStick || 0;
            const aButton = smash.aDirection || 0;
            return `C-Stick/A Button - ${cStick}/${aButton}`;
        }

        // Helper function to count aerial resolutions from events
        function countAerialResolutionFromEvents(events, attackType, resolutionType) {
            if (!events || !Array.isArray(events)) return 0;
            return events.filter(event => 
                event.resolution && 
                event.resolution.subtype === attackType && 
                event.resolution.type === resolutionType
            ).length;
        }

        function countLaserEvents(events, laserType = null) {
            if (!events || !Array.isArray(events)) return laserType ? { hit: 0, block: 0, whiff: 0, total: 0 } : 0;
            
            if (laserType) {
                const filteredEvents = events.filter(event => event.resolution && event.resolution.subtype === laserType);
                const breakdown = { hit: 0, block: 0, whiff: 0, total: filteredEvents.length };
                
                
                filteredEvents.forEach(event => {
                    const contactState = event.contactState;
                    if (contactState === 'hit') {
                        breakdown.hit++;
                    } else if (contactState === 'blocked') {
                        breakdown.block++;
                    } else {
                        breakdown.whiff++;
                    }
                });
                
                return breakdown;
            }
            
            return events.length;
        }

        function countShineEvents(events, shineType = null, resolutionType = null) {
            if (!events || !Array.isArray(events)) {
                return shineType || resolutionType ? { hit: 0, block: 0, whiff: 0, total: 0 } : 0;
            }
            
            let filteredEvents = events;
            
            // Filter by shine type (aerial/grounded) if specified
            if (shineType) {
                filteredEvents = filteredEvents.filter(event => event.type === shineType);
            }
            
            // Filter by resolution type if specified
            if (resolutionType) {
                filteredEvents = filteredEvents.filter(event => 
                    event.resolution && event.resolution.type === resolutionType);
            }
            
            if (shineType || resolutionType) {
                const breakdown = { hit: 0, block: 0, whiff: 0, total: filteredEvents.length };
                
                filteredEvents.forEach(event => {
                    const contactState = event.contactState || 'whiff';
                    if (contactState === 'hit') {
                        breakdown.hit++;
                    } else if (contactState === 'blocked') {
                        breakdown.block++;
                    } else {
                        breakdown.whiff++;
                    }
                });
                
                return breakdown;
            }
            
            return filteredEvents.length;
        }

        function countPhantasmEvents(events, phantasmType = null, resolutionType = null) {
            if (!events || !Array.isArray(events)) {
                return phantasmType || resolutionType ? { hit: 0, blocked: 0, whiff: 0, edgeGrab: 0, onStage: 0, death: 0, hitOut: 0, other: 0, total: 0 } : 0;
            }
            
            let filteredEvents = events;
            
            // Filter by phantasm type (aerial/grounded) if specified
            if (phantasmType) {
                filteredEvents = filteredEvents.filter(event => event.type === phantasmType);
            }
            
            // Filter by resolution type if specified
            if (resolutionType) {
                filteredEvents = filteredEvents.filter(event => 
                    event.resolution && event.resolution.subtype === resolutionType);
            }
            
            if (phantasmType || resolutionType) {
                const breakdown = { 
                    hit: 0, block: 0, whiff: 0, // Contact states
                    edgeGrab: 0, onStage: 0, death: 0, hitOut: 0, other: 0, // Resolution types
                    total: filteredEvents.length 
                };
                
                filteredEvents.forEach(event => {
                    // Count contact states (for hit/block/whiff display)
                    const contactState = event.contactState || 'whiff';
                    if (contactState === 'hit') {
                        breakdown.hit++;
                    } else if (contactState === 'blocked') {
                        breakdown.block++;
                    } else {
                        breakdown.whiff++;
                    }
                    
                    // Count resolution types (for resolution panels)
                    const resolutionSubtype = event.resolution ? event.resolution.subtype : 'other';
                    
                    // Map data subtypes to display keys
                    let mappedSubtype = resolutionSubtype;
                    if (resolutionSubtype === 'grabEdge') {
                        mappedSubtype = 'ledgeGrab';
                    }
                    
                    if (breakdown.hasOwnProperty(mappedSubtype) && mappedSubtype !== 'hit' && mappedSubtype !== 'blocked' && mappedSubtype !== 'whiff') {
                        breakdown[mappedSubtype]++;
                    } else if (mappedSubtype !== 'hit' && mappedSubtype !== 'blocked' && mappedSubtype !== 'whiff') {
                        breakdown.other++;
                    }
                });
                
                return breakdown;
            }
            
            return filteredEvents.length;
        }

        function countFirefoxEvents(events, firefoxType = null, resolutionType = null) {
            if (!events || !Array.isArray(events)) {
                return firefoxType || resolutionType ? { hit: 0, blocked: 0, whiff: 0, ledgeSnap: 0, ledgeGrab: 0, hitOut: 0, death: 0, landed: 0, other: 0, total: 0 } : 0;
            }
            
            let filteredEvents = events;
            
            // Filter by firefox type (aerial/grounded) if specified
            if (firefoxType) {
                filteredEvents = filteredEvents.filter(event => event.type === firefoxType);
            }
            
            // Filter by resolution type if specified
            if (resolutionType) {
                filteredEvents = filteredEvents.filter(event => 
                    event.resolution && event.resolution.subtype === resolutionType);
            }
            
            if (firefoxType || resolutionType) {
                const breakdown = { 
                    hit: 0, block: 0, whiff: 0, // Contact states
                    ledgeSnap: 0, ledgeGrab: 0, hitOut: 0, death: 0, landed: 0, other: 0, // Resolution types
                    total: filteredEvents.length 
                };
                
                filteredEvents.forEach(event => {
                    // Count contact states (for hit/block/whiff display)
                    const contactState = event.contactState || 'whiff';
                    if (contactState === 'hit') {
                        breakdown.hit++;
                    } else if (contactState === 'blocked') {
                        breakdown.block++;
                    } else {
                        breakdown.whiff++;
                    }
                    
                    // Count resolution types (for resolution panels)
                    const resolutionSubtype = event.resolution ? event.resolution.subtype : 'other';
                    
                    // Map data subtypes to display keys
                    let mappedSubtype = resolutionSubtype;
                    if (resolutionSubtype === 'grabEdge') {
                        mappedSubtype = 'ledgeGrab';
                    }
                    
                    // Map 'hit' resolution to 'hitOut' to differentiate from contact state
                    if (mappedSubtype === 'hit') {
                        breakdown.hitOut++;
                    } else if (breakdown.hasOwnProperty(mappedSubtype) && mappedSubtype !== 'hit' && mappedSubtype !== 'blocked' && mappedSubtype !== 'whiff') {
                        breakdown[mappedSubtype]++;
                    } else if (mappedSubtype !== 'hit' && mappedSubtype !== 'blocked' && mappedSubtype !== 'whiff') {
                        breakdown.other++;
                    }
                });
                
                return breakdown;
            }
            
            return filteredEvents.length;
        }

        function createLaserResolutionPanel(laserType, totals, playerSlot, isActive) {
            // Handle both old array format and new object format
            let laserEvents;
            if (Array.isArray(totals.laserEvents)) {
                laserEvents = totals.laserEvents;
            } else if (totals.laserEvents && typeof totals.laserEvents === 'object') {
                laserEvents = Object.values(totals.laserEvents).flat();
            } else {
                return '';
            }

            const mode = displayModes[`player${playerSlot}`]['specialResolution'] || 'breakdown';
            const gamesPlayed = playerDataSources[`player${playerSlot}`]?.playerData?.gamesPlayed || 1;
            
            // Calculate total for percentage calculations from events
            const laserData = countLaserEvents(laserEvents, laserType);
            const totalLasers = laserData.total;
            const categoryTotals = { total: totalLasers };

            return `
                <div class="laser-panel ${isActive ? 'active' : ''}" data-laser="${laserType}">
                    <div class="laser-resolution-header">
                        <div class="laser-resolution-spacer"></div>
                        ${createLaserResolutionToggles(playerSlot)}
                    </div>
                    <div class="resolution-breakdown">
                        <div class="resolution-category">
                            <h5>Contact Results - ${formatValue(totalLasers, mode, gamesPlayed, categoryTotals)}</h5>
                            <div class="technique-grid">
                                <div class="technique-item${laserData.hit === 0 ? ' zero-value' : ''}">Hit: <span>${formatValue(laserData.hit, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item${laserData.block === 0 ? ' zero-value' : ''}">Blocked: <span>${formatValue(laserData.block, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item${laserData.whiff === 0 ? ' zero-value' : ''}">Whiff: <span>${formatValue(laserData.whiff, mode, gamesPlayed, categoryTotals)}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createLaserResolutionToggles(playerSlot) {
            const currentMode = displayModes[`player${playerSlot}`]['specialResolution'] || 'breakdown';
            
            return `
                <div class="mode-toggles">
                    <button class="mode-toggle ${currentMode === 'breakdown' ? 'active' : ''}" onclick="setDisplayMode(${playerSlot}, 'specialResolution', 'breakdown')">Breakdown</button>
                    <button class="mode-toggle ${currentMode === 'per-game' ? 'active' : ''}" onclick="setDisplayMode(${playerSlot}, 'specialResolution', 'per-game')">Per Game</button>
                    <button class="mode-toggle ${currentMode === 'total' ? 'active' : ''}" onclick="setDisplayMode(${playerSlot}, 'specialResolution', 'total')">Total</button>
                </div>
            `;
        }

        // Helper function to create attack count object from events with hit/block/whiff breakdown
        function createAttackCountFromEvents(groundEvents, smashEvents, aerialEvents) {
            return {
                jab1: countGroundAttackEvents(groundEvents, 'jab1'),
                jab2: countGroundAttackEvents(groundEvents, 'jab2'),
                jab3: countGroundAttackEvents(groundEvents, 'jab3'),
                jabm: countGroundAttackEvents(groundEvents, 'rapidJab'),
                dash: countGroundAttackEvents(groundEvents, 'dash'),
                ftilt: countGroundAttackEvents(groundEvents, 'ftilt'),
                utilt: countGroundAttackEvents(groundEvents, 'utilt'),
                dtilt: countGroundAttackEvents(groundEvents, 'dtilt'),
                fsmash: countSmashAttackEvents(smashEvents, 'fsmash'),
                usmash: countSmashAttackEvents(smashEvents, 'usmash'),
                dsmash: countSmashAttackEvents(smashEvents, 'dsmash'),
                nair: countAerialAttackEvents(aerialEvents, 'nair'),
                fair: countAerialAttackEvents(aerialEvents, 'fair'),
                bair: countAerialAttackEvents(aerialEvents, 'bair'),
                uair: countAerialAttackEvents(aerialEvents, 'uair'),
                dair: countAerialAttackEvents(aerialEvents, 'dair')
            };
        }

        // Helper function to format attack breakdown with color coding
        function formatAttackBreakdown(breakdown, mode, gamesPlayed, categoryTotals) {
            if (typeof breakdown === 'number') {
                return `<span>${formatValue(breakdown, mode, gamesPlayed, categoryTotals)}</span>`;
            }
            
            const hit = breakdown.hit || 0;
            const block = breakdown.block || 0;  // Fixed: changed from breakdown.blocked to breakdown.block
            const whiff = breakdown.whiff || 0;
            const total = hit + block + whiff;
            
            if (mode === 'breakdown') {
                return `<span class="attack-breakdown-container"><span style="color: #68d391;">${hit}</span>   <span class="slash">|   </span><span style="color: #60a5fa;">${block}</span>   <span class="slash">|   </span><span style="color: #fbbf24;">${whiff}</span></span>`;
            } else {
                return `<span>${formatValue(total, mode, gamesPlayed, categoryTotals)}</span>`;
            }
        }


        function formatValue(value, mode, gamesPlayed, categoryTotals = null) {
            switch (mode) {
                case 'total':
                    return value;
                case 'per-game':
                    return gamesPlayed > 0 ? (value / gamesPlayed).toFixed(1) : '0.0';
                case 'percentage':
                    if (categoryTotals && categoryTotals.total > 0) {
                        return ((value / categoryTotals.total) * 100).toFixed(1) + '%';
                    }
                    return '0.0%';
                default:
                    return value;
            }
        }

        // Helper function to format subcategory totals (sums individual percentages in percentage mode)
        function formatSubcategoryTotal(subcategoryData, subcategoryKeys, mode, gamesPlayed, categoryTotals = null) {
            switch (mode) {
                case 'total':
                    return subcategoryKeys.reduce((sum, key) => sum + (subcategoryData[key] || 0), 0);
                case 'per-game':
                    const total = subcategoryKeys.reduce((sum, key) => sum + (subcategoryData[key] || 0), 0);
                    return gamesPlayed > 0 ? (total / gamesPlayed).toFixed(1) : '0.0';
                case 'percentage':
                    if (categoryTotals && categoryTotals.total > 0) {
                        // Sum the individual percentages
                        const percentageSum = subcategoryKeys.reduce((sum, key) => {
                            const value = subcategoryData[key] || 0;
                            return sum + ((value / categoryTotals.total) * 100);
                        }, 0);
                        return percentageSum.toFixed(1) + '%';
                    }
                    return '0.0%';
                default:
                    return subcategoryKeys.reduce((sum, key) => sum + (subcategoryData[key] || 0), 0);
            }
        }

        // Helper function to format category breakdown totals (hit | block | whiff)
        function formatCategoryBreakdown(hybridAttackData, subcategoryKeys, mode) {
            // Only show breakdown in breakdown mode
            if (mode !== 'breakdown') {
                return '';
            }
            
            let totalHit = 0, totalBlock = 0, totalWhiff = 0;
            
            subcategoryKeys.forEach(key => {
                const breakdown = hybridAttackData[key];
                if (breakdown && typeof breakdown === 'object') {
                    totalHit += breakdown.hit || 0;
                    totalBlock += breakdown.block || 0;
                    totalWhiff += breakdown.whiff || 0;
                }
            });
            
            return `<span class="attack-breakdown-container" style="margin-left: 10px;"><span style="color: #68d391;">${totalHit}</span>   <span class="slash">|   </span><span style="color: #60a5fa;">${totalBlock}</span>   <span class="slash">|   </span><span style="color: #fbbf24;">${totalWhiff}</span></span>`;
        }

        // Helper function to populate connect code dropdown from loaded data
        function populateConnectCodes(playerSlot, data) {
            const codeSelect = document.getElementById(`player${playerSlot}-code`);
            
            // Clear existing options except the first placeholder
            codeSelect.innerHTML = '<option value="">Select a connect code...</option>';
            
            // Get all connect codes from the data
            if (data && data.players) {
                const connectCodes = Object.keys(data.players).sort();
                
                // Add each connect code as an option
                connectCodes.forEach(code => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = code;
                    codeSelect.appendChild(option);
                });
                
                // Enable the dropdown and show count
                codeSelect.disabled = false;
            } else {
                codeSelect.disabled = true;
            }
        }

        function calculateCategoryTotals(totals, techniques) {
            let total = 0;
            techniques.forEach(tech => {
                if (typeof tech === 'string') {
                    total += totals[tech] || 0;
                } else if (typeof tech === 'object') {
                    // Handle nested objects like shineWavedashCount
                    const obj = totals[tech.key];
                    if (obj && tech.subKeys) {
                        tech.subKeys.forEach(subKey => {
                            total += obj[subKey] || 0;
                        });
                    }
                }
            });
            return { total };
        }

        function createBasicTechniques(totals, playerSlot) {
            const techniques = ['wavedashCount', 'wavelandCount', 'lCancelCount', 'dashDanceCount', 'ledgegrabCount', 'rollCount', 'airDodgeCount', 'spotDodgeCount'];
            const categoryTotals = calculateCategoryTotals(totals, techniques);
            const mode = displayModes[`player${playerSlot}`]['basic'];
            const gamesPlayed = playerDataSources[`player${playerSlot}`]?.playerData?.gamesPlayed || 1;

            return `
                <div class="category collapsible">
                    <h3 class="category-header">
                        <div class="category-header-text">
                            <span class="expand-icon">‚ñº</span>
                            Basic Techniques
                        </div>
                        ${createDisplayToggles(playerSlot, 'basic')}
                    </h3>
                    <div class="category-content">
                        <div class="technique-grid">
                            <div class="technique-item${totals.wavedashCount === 0 ? ' zero-value' : ''}">Wavedash: <span>${formatValue(totals.wavedashCount, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${totals.wavelandCount === 0 ? ' zero-value' : ''}">Waveland: <span>${formatValue(totals.wavelandCount, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${totals.lCancelCount === 0 ? ' zero-value' : ''}">L-Cancel: <span>${formatValue(totals.lCancelCount, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${totals.dashDanceCount === 0 ? ' zero-value' : ''}">Dash Dance: <span>${formatValue(totals.dashDanceCount, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${totals.ledgegrabCount === 0 ? ' zero-value' : ''}">Ledge Grab: <span>${formatValue(totals.ledgegrabCount, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${totals.rollCount === 0 ? ' zero-value' : ''}">Roll: <span>${formatValue(totals.rollCount, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${totals.airDodgeCount === 0 ? ' zero-value' : ''}">Air Dodge: <span>${formatValue(totals.airDodgeCount, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${totals.spotDodgeCount === 0 ? ' zero-value' : ''}">Spot Dodge: <span>${formatValue(totals.spotDodgeCount, mode, gamesPlayed, categoryTotals)}</span></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createPlatformMovement(totals, playerSlot) {
            // Calculate event-based totals for platform movement tabs
            const eventTotals = {
                shieldDrop: Object.values(totals.shieldDropEvents || {}).reduce((sum, events) => sum + events.length, 0),
                platformDrop: Object.values(totals.platformDropEvents || {}).reduce((sum, events) => sum + events.length, 0),
                runOff: Object.values(totals.runOffEvents || {}).reduce((sum, events) => sum + events.length, 0),
                wavelandOff: Object.values(totals.wavelandOffEvents || {}).reduce((sum, events) => sum + events.length, 0),
                noImpactLanding: totals.noImpactLandingCount || 0  // Keep counter for this one
            };
            const totalPlatformEvents = eventTotals.shieldDrop + eventTotals.platformDrop + eventTotals.runOff + eventTotals.wavelandOff + eventTotals.noImpactLanding;
            const categoryTotals = { total: totalPlatformEvents };
            const mode = displayModes[`player${playerSlot}`]['platform'];
            const gamesPlayed = playerDataSources[`player${playerSlot}`]?.playerData?.gamesPlayed || 1;

            return `
                <div class="category collapsible">
                    <h3 class="category-header">
                        <div class="category-header-text">
                            <span class="expand-icon">‚ñº</span>
                            Platform Movement
                        </div>
                        ${createDisplayToggles(playerSlot, 'platform')}
                    </h3>
                    <div class="category-content">
                        <div class="platform-grid">
                            <div class="platform-tab shield-drop${eventTotals.shieldDrop === 0 ? ' zero-value' : ''} active" data-platform="shieldDrop">Shield Drop: <span>${formatValue(eventTotals.shieldDrop, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="platform-tab platform-drop${eventTotals.platformDrop === 0 ? ' zero-value' : ''}" data-platform="platformDrop">Platform Drop: <span>${formatValue(eventTotals.platformDrop, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="platform-tab run-off${eventTotals.runOff === 0 ? ' zero-value' : ''}" data-platform="runOff">Run Off: <span>${formatValue(eventTotals.runOff, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="platform-tab waveland-off${eventTotals.wavelandOff === 0 ? ' zero-value' : ''}" data-platform="wavelandOff">Waveland Off: <span>${formatValue(eventTotals.wavelandOff, mode, gamesPlayed, categoryTotals)}</span></div>
                        </div>
                        
                        <div class="technique-item${eventTotals.noImpactLanding === 0 ? ' zero-value' : ''}" style="margin-top: 15px; text-align: center;">No-Impact Landing: <span>${formatValue(eventTotals.noImpactLanding, mode, gamesPlayed, categoryTotals)}</span></div>
                        
                        <div class="platform-details">
                            ${createPlatformSequencePanel('shieldDrop', 'Shield Drop', totals, playerSlot, true)}
                            ${createPlatformSequencePanel('platformDrop', 'Platform Drop', totals, playerSlot, false)}
                            ${createPlatformSequencePanel('runOff', 'Run Off', totals, playerSlot, false)}
                            ${createPlatformSequencePanel('wavelandOff', 'Waveland Off', totals, playerSlot, false)}
                        </div>
                    </div>
                </div>
            `;
        }


        function createSpecialsStatistics(totals, playerSlot) {
            // Handle both old array format and new object format for all special event types
            const laserEvents = Array.isArray(totals.laserEvents) 
                ? totals.laserEvents 
                : Object.values(totals.laserEvents || {}).flat();
            
            const shineEvents = Array.isArray(totals.shineEvents) 
                ? totals.shineEvents 
                : Object.values(totals.shineEvents || {}).flat();
                
            const phantasmEvents = Array.isArray(totals.phantasmEvents) 
                ? totals.phantasmEvents 
                : Object.values(totals.phantasmEvents || {}).flat();
                
            const firefoxEvents = Array.isArray(totals.firefoxEvents) 
                ? totals.firefoxEvents 
                : Object.values(totals.firefoxEvents || {}).flat();
                
            // Create laser count with hit/blocked/whiff breakdown from events
            const hybridLaserCount = {
                aerial: countLaserEvents(laserEvents, 'aerial'),
                standing: countLaserEvents(laserEvents, 'standing')
            };

            // Create shine count with hit/blocked/whiff breakdown from events
            const hybridShineCount = {
                aerial: countShineEvents(shineEvents, 'aerial'),
                grounded: countShineEvents(shineEvents, 'grounded')
            };

            // Create phantasm count with hit/blocked/whiff breakdown from events
            const hybridPhantasmCount = {
                aerial: countPhantasmEvents(phantasmEvents, 'aerial'),
                grounded: countPhantasmEvents(phantasmEvents, 'grounded')
            };

            // Create firefox count with hit/blocked/whiff breakdown from events
            const hybridFirefoxCount = {
                aerial: countFirefoxEvents(firefoxEvents, 'aerial'),
                grounded: countFirefoxEvents(firefoxEvents, 'grounded')
            };


            // Create laser totals-only version for subcategory calculations  
            const laserTotalsOnly = {
                aerial: hybridLaserCount.aerial.total || 0,
                standing: hybridLaserCount.standing.total || 0
            };

            // Create shine totals-only version for subcategory calculations  
            const shineTotalsOnly = {
                aerial: hybridShineCount.aerial.total || 0,
                grounded: hybridShineCount.grounded.total || 0
            };

            // Create phantasm totals-only version for subcategory calculations  
            const phantasmTotalsOnly = {
                aerial: hybridPhantasmCount.aerial.total || 0,
                grounded: hybridPhantasmCount.grounded.total || 0
            };

            // Create firefox totals-only version for subcategory calculations  
            const firefoxTotalsOnly = {
                aerial: hybridFirefoxCount.aerial.total || 0,
                grounded: hybridFirefoxCount.grounded.total || 0
            };


            const laserTechniques = ['aerial', 'standing'];
            const shineTechniques = ['aerial', 'grounded'];
            const phantasmTechniques = ['aerial', 'grounded'];
            const firefoxTechniques = ['aerial', 'grounded'];

            const laserCategoryTotals = calculateCategoryTotals({ laserCount: laserTotalsOnly }, [{ key: 'laserCount', subKeys: laserTechniques }]);
            const shineCategoryTotals = calculateCategoryTotals({ shineCount: shineTotalsOnly }, [{ key: 'shineCount', subKeys: shineTechniques }]);
            const phantasmCategoryTotals = calculateCategoryTotals({ phantasmCount: phantasmTotalsOnly }, [{ key: 'phantasmCount', subKeys: phantasmTechniques }]);
            const firefoxCategoryTotals = calculateCategoryTotals({ firefoxCount: firefoxTotalsOnly }, [{ key: 'firefoxCount', subKeys: firefoxTechniques }]);

            const mode = displayModes[`player${playerSlot}`]['specialResolution'] || 'breakdown';
            const gamesPlayed = playerDataSources[`player${playerSlot}`]?.playerData?.gamesPlayed || 1;

            // Calculate subcategory totals for display (using totals only)
            const laserTotal = formatSubcategoryTotal(laserTotalsOnly, ['aerial', 'standing'], mode, gamesPlayed, laserCategoryTotals);
            const shineTotal = formatSubcategoryTotal(shineTotalsOnly, ['aerial', 'grounded'], mode, gamesPlayed, shineCategoryTotals);
            const phantasmTotal = formatSubcategoryTotal(phantasmTotalsOnly, ['aerial', 'grounded'], mode, gamesPlayed, phantasmCategoryTotals);
            const firefoxTotal = formatSubcategoryTotal(firefoxTotalsOnly, ['aerial', 'grounded'], mode, gamesPlayed, firefoxCategoryTotals);
            
            return `
                <div class="category collapsible">
                    <h3 class="category-header">
                        <div class="category-header-text">
                            <span class="expand-icon">‚ñº</span>
                            Specials Statistics
                        </div>
                        <div class="display-toggles">
                            <div class="toggle-button ${displayModes[`player${playerSlot}`]['specialResolution'] === 'breakdown' ? 'active' : ''}" 
                                 data-player="${playerSlot}" data-category="specialResolution" data-mode="breakdown">Breakdown</div>
                            <div class="toggle-button ${displayModes[`player${playerSlot}`]['specialResolution'] === 'per-game' ? 'active' : ''}" 
                                 data-player="${playerSlot}" data-category="specialResolution" data-mode="per-game">Per Game</div>
                            <div class="toggle-button ${displayModes[`player${playerSlot}`]['specialResolution'] === 'total' ? 'active' : ''}" 
                                 data-player="${playerSlot}" data-category="specialResolution" data-mode="total">Total</div>
                        </div>
                    </h3>
                    <div class="category-content">
                        <div class="attack-section">
                            <h4>Lasers${mode === 'breakdown' ? '' : ' - ' + laserTotal}${formatCategoryBreakdown(hybridLaserCount, ['aerial', 'standing'], mode)}</h4>
                            <div class="technique-grid">
                                <div class="technique-item${(hybridLaserCount.aerial?.total || hybridLaserCount.aerial) === 0 ? ' zero-value' : ''}">Aerial Laser ${formatAttackBreakdown(hybridLaserCount.aerial, mode, gamesPlayed, laserCategoryTotals)}</div>
                                <div class="technique-item${(hybridLaserCount.standing?.total || hybridLaserCount.standing) === 0 ? ' zero-value' : ''}">Grounded Laser ${formatAttackBreakdown(hybridLaserCount.standing, mode, gamesPlayed, laserCategoryTotals)}</div>
                            </div>
                        </div>
                        
                        <div class="attack-section">
                            <h4>Shines${mode === 'breakdown' ? '' : ' - ' + shineTotal}${formatCategoryBreakdown(hybridShineCount, ['aerial', 'grounded'], mode)}</h4>
                            <div class="technique-grid">
                                <div class="technique-item${(hybridShineCount.aerial?.total || hybridShineCount.aerial) === 0 ? ' zero-value' : ''}">Aerial Shine ${formatAttackBreakdown(hybridShineCount.aerial, mode, gamesPlayed, shineCategoryTotals)}</div>
                                <div class="technique-item${(hybridShineCount.grounded?.total || hybridShineCount.grounded) === 0 ? ' zero-value' : ''}">Grounded Shine ${formatAttackBreakdown(hybridShineCount.grounded, mode, gamesPlayed, shineCategoryTotals)}</div>
                            </div>
                        </div>
                        
                        <div class="attack-section">
                            ${createPhantasmStatistics(totals, playerSlot)}
                        </div>

                        <div class="attack-section">
                            <h4>Firefox${mode === 'breakdown' ? '' : ' - ' + firefoxTotal}${formatCategoryBreakdown(hybridFirefoxCount, ['aerial', 'grounded'], mode)}</h4>
                            <div class="technique-grid">
                                <div class="technique-item firefox-tab${(hybridFirefoxCount.aerial?.total || hybridFirefoxCount.aerial) === 0 ? ' zero-value' : ''} active" data-firefox="aerial">Aerial Firefox ${formatAttackBreakdown(hybridFirefoxCount.aerial, mode, gamesPlayed, firefoxCategoryTotals)}</div>
                                <div class="technique-item firefox-tab${(hybridFirefoxCount.grounded?.total || hybridFirefoxCount.grounded) === 0 ? ' zero-value' : ''}" data-firefox="grounded">Grounded Firefox ${formatAttackBreakdown(hybridFirefoxCount.grounded, mode, gamesPlayed, firefoxCategoryTotals)}</div>
                            </div>
                            <div class="firefox-details">
                                ${createFirefoxResolutionPanel('aerial', hybridFirefoxCount.aerial, playerSlot, mode, gamesPlayed, {total: hybridFirefoxCount.aerial.ledgeSnap + hybridFirefoxCount.aerial.ledgeGrab + hybridFirefoxCount.aerial.hitOut + hybridFirefoxCount.aerial.death + hybridFirefoxCount.aerial.landed + hybridFirefoxCount.aerial.other}, true)}
                                ${createFirefoxResolutionPanel('grounded', hybridFirefoxCount.grounded, playerSlot, mode, gamesPlayed, {total: hybridFirefoxCount.grounded.ledgeSnap + hybridFirefoxCount.grounded.ledgeGrab + hybridFirefoxCount.grounded.hitOut + hybridFirefoxCount.grounded.death + hybridFirefoxCount.grounded.landed + hybridFirefoxCount.grounded.other}, false)}
                            </div>
                        </div>
                        
                    </div>
                </div>
            `;
        }

        function createShineStatistics(totals, playerSlot) {
            // Handle both old array format and new object format
            let shineEvents;
            if (Array.isArray(totals.shineEvents)) {
                shineEvents = totals.shineEvents;
            } else if (totals.shineEvents && typeof totals.shineEvents === 'object') {
                shineEvents = Object.values(totals.shineEvents).flat();
            } else {
                return `<h4>Shines - 0</h4>
                        <div class="technique-grid">
                            <div class="technique-item zero-value">Aerial Shine <span class="attack-breakdown-container"><span style="color: #68d391;">0</span>   <span class="slash">|   </span><span style="color: #60a5fa;">0</span>   <span class="slash">|   </span><span style="color: #fbbf24;">0</span></span></div>
                            <div class="technique-item zero-value">Grounded Shine <span class="attack-breakdown-container"><span style="color: #68d391;">0</span>   <span class="slash">|   </span><span style="color: #60a5fa;">0</span>   <span class="slash">|   </span><span style="color: #fbbf24;">0</span></span></div>
                        </div>`;
            }

            const mode = displayModes[`player${playerSlot}`]['specialResolution'] || 'breakdown';
            const gamesPlayed = playerDataSources[`player${playerSlot}`]?.playerData?.gamesPlayed || 1;

            // Get basic shine counts
            const groundedShineData = countShineEvents(shineEvents, 'grounded');
            const aerialShineData = countShineEvents(shineEvents, 'aerial');
            const groundedShineCount = groundedShineData.total || 0;
            const aerialShineCount = aerialShineData.total || 0;
            const totalShineCount = groundedShineCount + aerialShineCount;

            // Create shine totals-only version for subcategory calculations
            const shineTotalsOnly = {
                aerial: aerialShineCount,
                grounded: groundedShineCount
            };

            const shineTechniques = ['aerial', 'grounded'];
            const categoryTotals = calculateCategoryTotals({ shineCount: shineTotalsOnly }, [{ key: 'shineCount', subKeys: shineTechniques }]);

            // Calculate subcategory totals for display
            const shineTotal = formatSubcategoryTotal(shineTotalsOnly, ['aerial', 'grounded'], mode, gamesPlayed, categoryTotals);
            
            const formatShineBreakdown = (shineData) => {
                if (mode === 'breakdown') {
                    const hit = shineData.hit || 0;
                    const blocked = shineData.block || 0;
                    const whiff = shineData.whiff || 0;
                    return `<span class="attack-breakdown-container"><span style="color: #68d391;">${hit}</span>   <span class="slash">|   </span><span style="color: #60a5fa;">${blocked}</span>   <span class="slash">|   </span><span style="color: #fbbf24;">${whiff}</span></span>`;
                } else {
                    return formatValue(shineData.total || shineData, mode, gamesPlayed);
                }
            };

            // Create breakdown structure for formatCategoryBreakdown
            const shineBreakdownData = {
                aerial: aerialShineData,
                grounded: groundedShineData
            };

            return `
                <h4>Shines${mode === 'breakdown' ? '' : ' - ' + shineTotal}${formatCategoryBreakdown(shineBreakdownData, ['aerial', 'grounded'], mode)}</h4>
                <div class="technique-grid">
                    <div class="technique-item${aerialShineCount === 0 ? ' zero-value' : ''}">Aerial Shine ${formatShineBreakdown(aerialShineData)}</div>
                    <div class="technique-item${groundedShineCount === 0 ? ' zero-value' : ''}">Grounded Shine ${formatShineBreakdown(groundedShineData)}</div>
                </div>
            `;
        }

        function createPhantasmStatistics(totals, playerSlot) {
            // Handle both old array format and new object format
            let phantasmEvents;
            if (Array.isArray(totals.phantasmEvents)) {
                phantasmEvents = totals.phantasmEvents;
            } else if (totals.phantasmEvents && typeof totals.phantasmEvents === 'object') {
                phantasmEvents = Object.values(totals.phantasmEvents).flat();
            } else {
                return `<h4>Phantasms - 0</h4>
                        <div class="technique-grid">
                            <div class="technique-item firefox-tab zero-value active" data-phantasm="aerial">Aerial Phantasm: <span>0</span></div>
                            <div class="technique-item firefox-tab zero-value" data-phantasm="grounded">Grounded Phantasm: <span>0</span></div>
                        </div>
                        <div class="firefox-details">
                            ${createPhantasmResolutionPanel('aerial', {edgeGrab: 0, onStage: 0, hitOut: 0, death: 0, other: 0}, playerSlot, 'breakdown', 1, {total: 0}, true)}
                            ${createPhantasmResolutionPanel('grounded', {edgeGrab: 0, onStage: 0, hitOut: 0, death: 0, other: 0}, playerSlot, 'breakdown', 1, {total: 0}, false)}
                        </div>`;
            }

            const mode = displayModes[`player${playerSlot}`]['specialResolution'] || 'breakdown';
            const gamesPlayed = playerDataSources[`player${playerSlot}`]?.playerData?.gamesPlayed || 1;

            // Get basic phantasm counts
            const groundedPhantasmData = countPhantasmEvents(phantasmEvents, 'grounded');
            const aerialPhantasmData = countPhantasmEvents(phantasmEvents, 'aerial');
            const groundedPhantasmCount = groundedPhantasmData.total || 0;
            const aerialPhantasmCount = aerialPhantasmData.total || 0;
            const totalPhantasmCount = groundedPhantasmCount + aerialPhantasmCount;

            // Create phantasm totals-only version for subcategory calculations
            const phantasmTotalsOnly = {
                aerial: aerialPhantasmCount,
                grounded: groundedPhantasmCount
            };

            const phantasmTechniques = ['aerial', 'grounded'];
            const phantasmCategoryTotals = calculateCategoryTotals({ phantasmCount: phantasmTotalsOnly }, [{ key: 'phantasmCount', subKeys: phantasmTechniques }]);

            // Calculate subcategory totals for display
            const phantasmTotal = formatSubcategoryTotal(phantasmTotalsOnly, ['aerial', 'grounded'], mode, gamesPlayed, phantasmCategoryTotals);


            // Calculate totals for percentage calculations
            const groundedResolutionTotal = groundedPhantasmData.edgeGrab + groundedPhantasmData.onStage + groundedPhantasmData.death + groundedPhantasmData.hitOut + groundedPhantasmData.other;
            const aerialResolutionTotal = aerialPhantasmData.edgeGrab + aerialPhantasmData.onStage + aerialPhantasmData.death + aerialPhantasmData.hitOut + aerialPhantasmData.other;
            const groundedCategoryTotals = { total: groundedResolutionTotal };
            const aerialCategoryTotals = { total: aerialResolutionTotal };

            // Create breakdown structure for formatCategoryBreakdown
            const phantasmBreakdownData = {
                aerial: aerialPhantasmData,
                grounded: groundedPhantasmData
            };

            return `
                <h4>Phantasms${mode === 'breakdown' ? '' : ' - ' + phantasmTotal}${formatCategoryBreakdown(phantasmBreakdownData, ['aerial', 'grounded'], mode)}</h4>
                <div class="firefox-grid">
                    <div class="firefox-tab${aerialPhantasmCount === 0 ? ' zero-value' : ''} active" data-phantasm="aerial">Aerial Phantasm ${formatAttackBreakdown(aerialPhantasmData, mode, gamesPlayed, phantasmCategoryTotals)}</div>
                    <div class="firefox-tab${groundedPhantasmCount === 0 ? ' zero-value' : ''}" data-phantasm="grounded">Grounded Phantasm ${formatAttackBreakdown(groundedPhantasmData, mode, gamesPlayed, phantasmCategoryTotals)}</div>
                </div>
                
                <div class="firefox-details">
                    ${createPhantasmResolutionPanel('aerial', aerialPhantasmData, playerSlot, mode, gamesPlayed, aerialCategoryTotals, true)}
                    ${createPhantasmResolutionPanel('grounded', groundedPhantasmData, playerSlot, mode, gamesPlayed, groundedCategoryTotals, false)}
                </div>
            `;
        }

        function createPhantasmResolutionPanel(phantasmType, phantasmData, playerSlot, mode, gamesPlayed, categoryTotals, isActive) {
            return `
                <div class="firefox-panel ${phantasmType}-panel${isActive ? ' active' : ''}" data-phantasm="${phantasmType}">
                    <div class="technique-panel-content">
                        <h5>${phantasmType === 'aerial' ? 'Aerial' : 'Grounded'} Phantasm Resolutions</h5>
                        <div class="technique-grid">
                            <div class="technique-item${phantasmData.edgeGrab === 0 ? ' zero-value' : ''}">Ledge Grab: <span>${formatValue(phantasmData.edgeGrab, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${phantasmData.onStage === 0 ? ' zero-value' : ''}">On Stage: <span>${formatValue(phantasmData.onStage, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${phantasmData.hitOut === 0 ? ' zero-value' : ''}">Hit Out: <span>${formatValue(phantasmData.hitOut, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${phantasmData.death === 0 ? ' zero-value' : ''}">Death: <span>${formatValue(phantasmData.death, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${phantasmData.other === 0 ? ' zero-value' : ''}">Other: <span>${formatValue(phantasmData.other, mode, gamesPlayed, categoryTotals)}</span></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createFirefoxStatistics(totals, playerSlot) {
            // Handle both old array format and new object format
            let firefoxEvents;
            if (Array.isArray(totals.firefoxEvents)) {
                firefoxEvents = totals.firefoxEvents;
            } else if (totals.firefoxEvents && typeof totals.firefoxEvents === 'object') {
                firefoxEvents = Object.values(totals.firefoxEvents).flat();
            } else {
                return `<h4>Firefox - 0</h4>
                        <div class="technique-grid">
                            <div class="technique-item zero-value">Aerial Firefox: <span>0</span></div>
                            <div class="technique-item zero-value">Grounded Firefox: <span>0</span></div>
                        </div>
                        <div class="firefox-resolutions">
                            <div class="firefox-resolution-toggles">
                                <h5>Aerial Firefox Resolutions</h5>
                                <div class="technique-grid">
                                    <div class="technique-item zero-value">Ledge Snap: <span>0</span></div>
                                    <div class="technique-item zero-value">Ledge Grab: <span>0</span></div>
                                    <div class="technique-item zero-value">On Stage: <span>0</span></div>
                                    <div class="technique-item zero-value">Hit Out: <span>0</span></div>
                                    <div class="technique-item zero-value">Death: <span>0</span></div>
                                    <div class="technique-item zero-value">Other: <span>0</span></div>
                                </div>
                            </div>
                            <div class="firefox-resolution-toggles">
                                <h5>Grounded Firefox Resolutions</h5>
                                <div class="technique-grid">
                                    <div class="technique-item zero-value">Ledge Snap: <span>0</span></div>
                                    <div class="technique-item zero-value">Ledge Grab: <span>0</span></div>
                                    <div class="technique-item zero-value">On Stage: <span>0</span></div>
                                    <div class="technique-item zero-value">Hit Out: <span>0</span></div>
                                    <div class="technique-item zero-value">Death: <span>0</span></div>
                                    <div class="technique-item zero-value">Other: <span>0</span></div>
                                </div>
                            </div>
                        </div>`;
            }

            const mode = displayModes[`player${playerSlot}`]['specialResolution'] || 'breakdown';
            const gamesPlayed = playerDataSources[`player${playerSlot}`]?.playerData?.gamesPlayed || 1;

            // Get basic firefox counts
            const groundedFirefoxData = countFirefoxEvents(firefoxEvents, 'grounded');
            const aerialFirefoxData = countFirefoxEvents(firefoxEvents, 'aerial');
            const groundedFirefoxCount = groundedFirefoxData.total || 0;
            const aerialFirefoxCount = aerialFirefoxData.total || 0;
            const totalFirefoxCount = groundedFirefoxCount + aerialFirefoxCount;

            // Create firefox totals-only version for subcategory calculations
            const firefoxTotalsOnly = {
                aerial: aerialFirefoxCount,
                grounded: groundedFirefoxCount
            };

            const firefoxTechniques = ['aerial', 'grounded'];
            const firefoxCategoryTotals = calculateCategoryTotals({ firefoxCount: firefoxTotalsOnly }, [{ key: 'firefoxCount', subKeys: firefoxTechniques }]);

            // Calculate subcategory totals for display
            const firefoxTotal = formatSubcategoryTotal(firefoxTotalsOnly, ['aerial', 'grounded'], mode, gamesPlayed, firefoxCategoryTotals);

            // Helper function to format firefox breakdown (hit/block/whiff)
            const formatFirefoxBreakdown = (firefoxData) => {
                if (mode === 'breakdown') {
                    const hit = firefoxData.hit || 0;
                    const blocked = firefoxData.block || 0;
                    const whiff = firefoxData.whiff || 0;
                    return `<span class="attack-breakdown-container"><span style="color: #68d391;">${hit}</span>   <span class="slash">|   </span><span style="color: #60a5fa;">${blocked}</span>   <span class="slash">|   </span><span style="color: #fbbf24;">${whiff}</span></span>`;
                } else {
                    return formatValue(firefoxData.total || firefoxData, mode, gamesPlayed);
                }
            };

            // Calculate totals for percentage calculations
            const groundedResolutionTotal = groundedFirefoxData.ledgeSnap + groundedFirefoxData.ledgeGrab + groundedFirefoxData.hitOut + groundedFirefoxData.death + groundedFirefoxData.landed + groundedFirefoxData.other;
            const aerialResolutionTotal = aerialFirefoxData.ledgeSnap + aerialFirefoxData.ledgeGrab + aerialFirefoxData.hitOut + aerialFirefoxData.death + aerialFirefoxData.landed + aerialFirefoxData.other;
            const groundedCategoryTotals = { total: groundedResolutionTotal };
            const aerialCategoryTotals = { total: aerialResolutionTotal };

            // Create breakdown structure for formatCategoryBreakdown
            const firefoxBreakdownData = {
                aerial: aerialFirefoxData,
                grounded: groundedFirefoxData
            };

            return `
                <h4>Firefox${mode === 'breakdown' ? '' : ' - ' + firefoxTotal}${formatCategoryBreakdown(firefoxBreakdownData, ['aerial', 'grounded'], mode)}</h4>
                <div class="firefox-grid">
                    <div class="firefox-tab${aerialFirefoxCount === 0 ? ' zero-value' : ''} active" data-firefox="aerial">Aerial Firefox ${formatFirefoxBreakdown(aerialFirefoxData)}</div>
                    <div class="firefox-tab${groundedFirefoxCount === 0 ? ' zero-value' : ''}" data-firefox="grounded">Grounded Firefox ${formatFirefoxBreakdown(groundedFirefoxData)}</div>
                </div>
                
                <div class="firefox-details">
                    ${createFirefoxResolutionPanel('aerial', aerialFirefoxData, playerSlot, mode, gamesPlayed, aerialCategoryTotals, true)}
                    ${createFirefoxResolutionPanel('grounded', groundedFirefoxData, playerSlot, mode, gamesPlayed, groundedCategoryTotals, false)}
                </div>
            `;
        }

        function createFirefoxResolutionPanel(firefoxType, firefoxData, playerSlot, mode, gamesPlayed, categoryTotals, isActive) {
            return `
                <div class="firefox-panel ${firefoxType}-panel${isActive ? ' active' : ''}" data-firefox="${firefoxType}">
                    <div class="technique-panel-content">
                        <h5>${firefoxType === 'aerial' ? 'Aerial' : 'Grounded'} Firefox Resolutions</h5>
                        <div class="technique-grid">
                            <div class="technique-item${firefoxData.ledgeSnap === 0 ? ' zero-value' : ''}">Ledge Snap: <span>${formatValue(firefoxData.ledgeSnap, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${firefoxData.ledgeGrab === 0 ? ' zero-value' : ''}">Ledge Grab: <span>${formatValue(firefoxData.ledgeGrab, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${firefoxData.landed === 0 ? ' zero-value' : ''}">On Stage: <span>${formatValue(firefoxData.landed, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${firefoxData.hitOut === 0 ? ' zero-value' : ''}">Hit Out: <span>${formatValue(firefoxData.hitOut, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${firefoxData.death === 0 ? ' zero-value' : ''}">Death: <span>${formatValue(firefoxData.death, mode, gamesPlayed, categoryTotals)}</span></div>
                            <div class="technique-item${firefoxData.other === 0 ? ' zero-value' : ''}">Other: <span>${formatValue(firefoxData.other, mode, gamesPlayed, categoryTotals)}</span></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createAttackStatistics(totals, playerSlot) {
            // Handle both old array format and new object format for all attack event types
            const groundEvents = Array.isArray(totals.groundAttackEvents) 
                ? totals.groundAttackEvents 
                : Object.values(totals.groundAttackEvents || {}).flat();
            
            const smashEvents = Array.isArray(totals.smashAttackEvents) 
                ? totals.smashAttackEvents 
                : Object.values(totals.smashAttackEvents || {}).flat();
                
            const aerialEvents = Array.isArray(totals.aerialAttackEvents) 
                ? totals.aerialAttackEvents 
                : Object.values(totals.aerialAttackEvents || {}).flat();
                
            // Create attack count with hit/block/whiff breakdown from events
            const hybridAttackCount = createAttackCountFromEvents(
                groundEvents, 
                smashEvents, 
                aerialEvents
            );

            // Create a totals-only version for subcategory calculations
            const attackTotalsOnly = {};
            Object.keys(hybridAttackCount).forEach(key => {
                const value = hybridAttackCount[key];
                attackTotalsOnly[key] = typeof value === 'object' && value.total !== undefined ? value.total : value;
            });

            const attackTechniques = ['jab1', 'jab2', 'jab3', 'jabm', 'dash', 'ftilt', 'utilt', 'dtilt', 'fsmash', 'usmash', 'dsmash', 'nair', 'fair', 'bair', 'uair', 'dair'];
            const categoryTotals = calculateCategoryTotals({ attackCount: attackTotalsOnly }, [{ key: 'attackCount', subKeys: attackTechniques }]);
            const mode = displayModes[`player${playerSlot}`]['attack'];
            const gamesPlayed = playerDataSources[`player${playerSlot}`]?.playerData?.gamesPlayed || 1;

            // Calculate subcategory totals for display (using totals only)
            const groundTotal = formatSubcategoryTotal(attackTotalsOnly, ['jab1', 'jab2', 'jab3', 'jabm', 'dash'], mode, gamesPlayed, categoryTotals);
            const tiltTotal = formatSubcategoryTotal(attackTotalsOnly, ['ftilt', 'utilt', 'dtilt'], mode, gamesPlayed, categoryTotals);
            const smashTotal = formatSubcategoryTotal(attackTotalsOnly, ['fsmash', 'usmash', 'dsmash'], mode, gamesPlayed, categoryTotals);
            const aerialTotal = formatSubcategoryTotal(attackTotalsOnly, ['nair', 'fair', 'bair', 'uair', 'dair'], mode, gamesPlayed, categoryTotals);
            
            return `
                <div class="category collapsible">
                    <h3 class="category-header">
                        <div class="category-header-text">
                            <span class="expand-icon">‚ñº</span>
                            Attack Statistics
                        </div>
                        <div class="display-toggles">
                            <div class="toggle-button ${displayModes[`player${playerSlot}`]['attack'] === 'breakdown' ? 'active' : ''}" 
                                 data-player="${playerSlot}" data-category="attack" data-mode="breakdown">Breakdown</div>
                            <div class="toggle-button ${displayModes[`player${playerSlot}`]['attack'] === 'per-game' ? 'active' : ''}" 
                                 data-player="${playerSlot}" data-category="attack" data-mode="per-game">Per Game</div>
                            <div class="toggle-button ${displayModes[`player${playerSlot}`]['attack'] === 'total' ? 'active' : ''}" 
                                 data-player="${playerSlot}" data-category="attack" data-mode="total">Total</div>
                        </div>
                    </h3>
                    <div class="category-content">
                        <div class="attack-section">
                            <h4>Ground Attacks${mode === 'breakdown' ? '' : ' - ' + groundTotal}${formatCategoryBreakdown(hybridAttackCount, ['jab1', 'jab2', 'jab3', 'jabm', 'dash'], mode)}</h4>
                            <div class="technique-grid">
                                <div class="technique-item${(hybridAttackCount.jab1?.total || hybridAttackCount.jab1) === 0 ? ' zero-value' : ''}">Jab 1 ${formatAttackBreakdown(hybridAttackCount.jab1, mode, gamesPlayed, categoryTotals)}</div>
                                <div class="technique-item${(hybridAttackCount.jab2?.total || hybridAttackCount.jab2) === 0 ? ' zero-value' : ''}">Jab 2 ${formatAttackBreakdown(hybridAttackCount.jab2, mode, gamesPlayed, categoryTotals)}</div>
                                <div class="technique-item${(hybridAttackCount.jab3?.total || hybridAttackCount.jab3) === 0 ? ' zero-value' : ''}">Jab 3 ${formatAttackBreakdown(hybridAttackCount.jab3, mode, gamesPlayed, categoryTotals)}</div>
                                <div class="technique-item${(hybridAttackCount.jabm?.total || hybridAttackCount.jabm) === 0 ? ' zero-value' : ''}">Rapid Jab ${formatAttackBreakdown(hybridAttackCount.jabm, mode, gamesPlayed, categoryTotals)}</div>
                                <div class="technique-item${(hybridAttackCount.dash?.total || hybridAttackCount.dash) === 0 ? ' zero-value' : ''}">Dash Attack ${formatAttackBreakdown(hybridAttackCount.dash, mode, gamesPlayed, categoryTotals)}</div>
                            </div>
                            
                            <div class="section-breaker"></div>
                            
                            <h4>Tilts${mode === 'breakdown' ? '' : ' - ' + tiltTotal}${formatCategoryBreakdown(hybridAttackCount, ['ftilt', 'utilt', 'dtilt'], mode)}</h4>
                            <div class="technique-grid">
                                <div class="technique-item${(hybridAttackCount.ftilt?.total || hybridAttackCount.ftilt) === 0 ? ' zero-value' : ''}">Forward Tilt ${formatAttackBreakdown(hybridAttackCount.ftilt, mode, gamesPlayed, categoryTotals)}</div>
                                <div class="technique-item${(hybridAttackCount.utilt?.total || hybridAttackCount.utilt) === 0 ? ' zero-value' : ''}">Up Tilt ${formatAttackBreakdown(hybridAttackCount.utilt, mode, gamesPlayed, categoryTotals)}</div>
                                <div class="technique-item${(hybridAttackCount.dtilt?.total || hybridAttackCount.dtilt) === 0 ? ' zero-value' : ''}">Down Tilt ${formatAttackBreakdown(hybridAttackCount.dtilt, mode, gamesPlayed, categoryTotals)}</div>
                            </div>
                            
                            <div class="section-breaker"></div>
                            
                            <h4>Smash Attacks${mode === 'breakdown' ? '' : ' - ' + smashTotal}${formatCategoryBreakdown(hybridAttackCount, ['fsmash', 'usmash', 'dsmash'], mode)}</h4>
                            <div class="technique-grid">
                                <div class="technique-item tooltip${(hybridAttackCount.fsmash?.total || hybridAttackCount.fsmash) === 0 ? ' zero-value' : ''}" data-tooltip="${generateSmashExecutionTooltip(totals.smashExecutionCount?.fsmash || {})}">Forward Smash ${formatAttackBreakdown(hybridAttackCount.fsmash, mode, gamesPlayed, categoryTotals)}</div>
                                <div class="technique-item tooltip${(hybridAttackCount.usmash?.total || hybridAttackCount.usmash) === 0 ? ' zero-value' : ''}" data-tooltip="${generateSmashExecutionTooltip(totals.smashExecutionCount?.usmash || {})}">Up Smash ${formatAttackBreakdown(hybridAttackCount.usmash, mode, gamesPlayed, categoryTotals)}</div>
                                <div class="technique-item tooltip${(hybridAttackCount.dsmash?.total || hybridAttackCount.dsmash) === 0 ? ' zero-value' : ''}" data-tooltip="${generateSmashExecutionTooltip(totals.smashExecutionCount?.dsmash || {})}">Down Smash ${formatAttackBreakdown(hybridAttackCount.dsmash, mode, gamesPlayed, categoryTotals)}</div>
                            </div>
                            
                            <div class="section-breaker"></div>
                            
                            <h4>Aerial Attacks${mode === 'breakdown' ? '' : ' - ' + aerialTotal}${formatCategoryBreakdown(hybridAttackCount, ['nair', 'fair', 'bair', 'uair', 'dair'], mode)}</h4>
                            <div class="aerial-grid">
                                <div class="aerial-tab tooltip uair${(hybridAttackCount.uair?.total || hybridAttackCount.uair) === 0 ? ' zero-value' : ''}" data-aerial="uair" data-tooltip="${generateAerialExecutionTooltip(totals, 'uair')}">Up Air ${formatAttackBreakdown(hybridAttackCount.uair, mode, gamesPlayed, categoryTotals)}</div>
                                <div class="aerial-tab tooltip bair${(hybridAttackCount.bair?.total || hybridAttackCount.bair) === 0 ? ' zero-value' : ''}" data-aerial="bair" data-tooltip="${generateAerialExecutionTooltip(totals, 'bair')}">Back Air ${formatAttackBreakdown(hybridAttackCount.bair, mode, gamesPlayed, categoryTotals)}</div>
                                <div class="aerial-tab tooltip nair${(hybridAttackCount.nair?.total || hybridAttackCount.nair) === 0 ? ' zero-value' : ''} active" data-aerial="nair" data-tooltip="${generateAerialExecutionTooltip(totals, 'nair')}">Neutral Air ${formatAttackBreakdown(hybridAttackCount.nair, mode, gamesPlayed, categoryTotals)}</div>
                                <div class="aerial-tab tooltip fair${(hybridAttackCount.fair?.total || hybridAttackCount.fair) === 0 ? ' zero-value' : ''}" data-aerial="fair" data-tooltip="${generateAerialExecutionTooltip(totals, 'fair')}">Forward Air ${formatAttackBreakdown(hybridAttackCount.fair, mode, gamesPlayed, categoryTotals)}</div>
                                <div class="aerial-tab tooltip dair${(hybridAttackCount.dair?.total || hybridAttackCount.dair) === 0 ? ' zero-value' : ''}" data-aerial="dair" data-tooltip="${generateAerialExecutionTooltip(totals, 'dair')}">Down Air ${formatAttackBreakdown(hybridAttackCount.dair, mode, gamesPlayed, categoryTotals)}</div>
                            </div>
                            
                            <div class="aerial-details">
                                ${createAerialResolutionPanel('nair', totals, playerSlot, true)}
                                ${createAerialResolutionPanel('fair', totals, playerSlot, false)}
                                ${createAerialResolutionPanel('bair', totals, playerSlot, false)}
                                ${createAerialResolutionPanel('uair', totals, playerSlot, false)}
                                ${createAerialResolutionPanel('dair', totals, playerSlot, false)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        function createShineMovement(totals, playerSlot) {
            const shineTechniques = [
                { key: 'shineWavedashCount', subKeys: ['regular', 'framePerfect', 'regularTurn', 'framePerfectTurn'] },
                { key: 'shineWavelandCount', subKeys: ['regular', 'turn'] },
                { key: 'shineGrabCount', subKeys: ['regular', 'framePerfect', 'regularTurn', 'framePerfectTurn'] },
                'shineTurnaroundFirefoxLedgeGrabCount'
            ];
            const categoryTotals = calculateCategoryTotals(totals, shineTechniques);
            const mode = displayModes[`player${playerSlot}`]['shine'];
            const gamesPlayed = playerDataSources[`player${playerSlot}`]?.playerData?.gamesPlayed || 1;

            return `
                <div class="category collapsible">
                    <h3 class="category-header">
                        <div class="category-header-text">
                            <span class="expand-icon">‚ñº</span>
                            Shine Movement
                        </div>
                        ${createDisplayToggles(playerSlot, 'shine')}
                    </h3>
                    <div class="category-content">
                        <div class="shine-section">
                            <h4>Shine Wavedash - ${formatSubcategoryTotal(totals.shineWavedashCount || {}, ['regular', 'framePerfect', 'regularTurn', 'framePerfectTurn'], mode, gamesPlayed, categoryTotals)}</h4>
                            <div class="shine-technique-grid">
                                <div class="technique-item regular${totals.shineWavedashCount.regular === 0 ? ' zero-value' : ''}">Regular: <span>${formatValue(totals.shineWavedashCount.regular, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item frame-perfect${totals.shineWavedashCount.framePerfect === 0 ? ' zero-value' : ''}">Frame Perfect: <span>${formatValue(totals.shineWavedashCount.framePerfect, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item regular-turn${totals.shineWavedashCount.regularTurn === 0 ? ' zero-value' : ''}">Regular Turn: <span>${formatValue(totals.shineWavedashCount.regularTurn, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item frame-perfect-turn${totals.shineWavedashCount.framePerfectTurn === 0 ? ' zero-value' : ''}">Frame Perfect Turn: <span>${formatValue(totals.shineWavedashCount.framePerfectTurn, mode, gamesPlayed, categoryTotals)}</span></div>
                            </div>
                        </div>
                        
                        <div class="shine-section">
                            <h4>Shine Waveland - ${formatSubcategoryTotal(totals.shineWavelandCount || {}, ['regular', 'turn'], mode, gamesPlayed, categoryTotals)}</h4>
                            <div class="technique-grid">
                                <div class="technique-item${totals.shineWavelandCount.regular === 0 ? ' zero-value' : ''}">Regular: <span>${formatValue(totals.shineWavelandCount.regular, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item${totals.shineWavelandCount.turn === 0 ? ' zero-value' : ''}">Turn: <span>${formatValue(totals.shineWavelandCount.turn, mode, gamesPlayed, categoryTotals)}</span></div>
                            </div>
                        </div>
                        
                        <div class="shine-section">
                            <h4>Shine Grab - ${formatSubcategoryTotal(totals.shineGrabCount || {}, ['regular', 'framePerfect', 'regularTurn', 'framePerfectTurn'], mode, gamesPlayed, categoryTotals)}</h4>
                            <div class="shine-technique-grid">
                                <div class="technique-item regular${totals.shineGrabCount.regular === 0 ? ' zero-value' : ''}">Regular: <span>${formatValue(totals.shineGrabCount.regular, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item frame-perfect${totals.shineGrabCount.framePerfect === 0 ? ' zero-value' : ''}">Frame Perfect: <span>${formatValue(totals.shineGrabCount.framePerfect, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item regular-turn${totals.shineGrabCount.regularTurn === 0 ? ' zero-value' : ''}">Regular Turn: <span>${formatValue(totals.shineGrabCount.regularTurn, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item frame-perfect-turn${totals.shineGrabCount.framePerfectTurn === 0 ? ' zero-value' : ''}">Frame Perfect Turn: <span>${formatValue(totals.shineGrabCount.framePerfectTurn, mode, gamesPlayed, categoryTotals)}</span></div>
                            </div>
                        </div>
                        
                        <div class="technique-item${totals.shineTurnaroundFirefoxLedgeGrabCount === 0 ? ' zero-value' : ''}">Shine Turnaround Firefox Ledge Grab: <span>${formatValue(totals.shineTurnaroundFirefoxLedgeGrabCount, mode, gamesPlayed, categoryTotals)}</span></div>
                    </div>
                </div>
            `;
        }

        // Helper function to check if player can use character specials (Fox or Falco)
        function canUseCharacterSpecials(playerSlot) {
            const playerData = playerDataSources[`player${playerSlot}`]?.playerData;
            if (!playerData || !playerData.characters) return false;
            
            // Fox = characterId 2, Falco = characterId 20
            return playerData.characters.includes(2) || playerData.characters.includes(20);
        }

        // Helper functions to tally event outcomes for platform movements
        function tallyEventOutcomes(events) {
            const tally = {
                aerial: { nair: 0, fair: 0, bair: 0, uair: 0, dair: 0, total: 0 },
                characterSpecials: { phantasm: 0, shine: 0, laser: 0, total: 0 },
                movement: { land: 0, jump: 0, grabEdge: 0, waveLand: 0, airDodge: 0 },
                damage: { hit: 0 },
                other: { timeout: 0 }
            };

            events.forEach(event => {
                const { type, subtype } = event.resolution;
                
                if (type === 'aerial') {
                    tally.aerial[subtype] = (tally.aerial[subtype] || 0) + 1;
                    tally.aerial.total += 1;
                } else if (type === 'special') {
                    tally.characterSpecials[subtype] = (tally.characterSpecials[subtype] || 0) + 1;
                    tally.characterSpecials.total += 1;
                } else if (type === 'movement') {
                    tally.movement[subtype] = (tally.movement[subtype] || 0) + 1;
                } else if (type === 'damage') {
                    tally.damage[subtype] = (tally.damage[subtype] || 0) + 1;
                } else if (type === 'other') {
                    tally.other[subtype] = (tally.other[subtype] || 0) + 1;
                }
            });

            return tally;
        }

        function createPlatformSequencePanel(platformType, displayName, totals, playerSlot, isActive) {
            const sequences = totals.platformMovementSequences?.[platformType]?.sequences;
            if (!sequences) return '';

            // Get events for this platform type - now grouped by replay file
            const eventArrayMap = {
                'shieldDrop': 'shieldDropEvents',
                'platformDrop': 'platformDropEvents', 
                'runOff': 'runOffEvents',
                'wavelandOff': 'wavelandOffEvents'
            };
            const eventArrayName = eventArrayMap[platformType];
            const eventsByReplay = totals[eventArrayName] || {};
            
            // Flatten all events across replay files
            const events = Object.values(eventsByReplay).flat();
            
            // Tally event outcomes
            const eventTally = tallyEventOutcomes(events);

            const mode = displayModes[`player${playerSlot}`]['platformSequences'];
            const gamesPlayed = playerDataSources[`player${playerSlot}`]?.playerData?.gamesPlayed || 1;
            
            // Calculate event-based totals for percentage calculations
            const totalResolutions = eventTally.aerial.total + 
                                   eventTally.movement.land + 
                                   eventTally.movement.jump + 
                                   eventTally.damage.hit + 
                                   eventTally.movement.grabEdge + 
                                   eventTally.movement.waveLand + 
                                   eventTally.movement.airDodge + 
                                   eventTally.characterSpecials.total + 
                                   eventTally.other.timeout;
            
            const categoryTotals = { total: totalResolutions };
            
            // Calculate section totals
            const aerialTotal = eventTally.aerial.total;
            const characterSpecialsTotal = eventTally.characterSpecials.total;
            // Only subtract Character Specials from Other total if this player can use them
            const characterSpecialsToSubtract = canUseCharacterSpecials(playerSlot) ? characterSpecialsTotal : 0;
            const otherTotal = totalResolutions - aerialTotal - characterSpecialsToSubtract;

            return `
                <div class="platform-sequence-panel ${isActive ? 'active' : ''}" data-platform="${platformType}">
                    <div class="platform-sequence-header">
                        <div class="platform-sequence-spacer"></div>
                        ${createPlatformSequenceToggles(playerSlot)}
                    </div>
                    <div class="sequence-breakdown">
                        <div class="sequence-row">
                            <div class="sequence-category${canUseCharacterSpecials(playerSlot) ? '' : ' full-width'}">
                                <h5>Aerial Attacks - ${formatValue(aerialTotal, mode, gamesPlayed, categoryTotals)}</h5>
                                <div class="technique-grid">
                                    <div class="technique-item${eventTally.aerial.nair === 0 ? ' zero-value' : ''}">Neutral Air: <span>${formatValue(eventTally.aerial.nair, mode, gamesPlayed, categoryTotals)}</span></div>
                                    <div class="technique-item${eventTally.aerial.fair === 0 ? ' zero-value' : ''}">Forward Air: <span>${formatValue(eventTally.aerial.fair, mode, gamesPlayed, categoryTotals)}</span></div>
                                    <div class="technique-item${eventTally.aerial.bair === 0 ? ' zero-value' : ''}">Back Air: <span>${formatValue(eventTally.aerial.bair, mode, gamesPlayed, categoryTotals)}</span></div>
                                    <div class="technique-item${eventTally.aerial.uair === 0 ? ' zero-value' : ''}">Up Air: <span>${formatValue(eventTally.aerial.uair, mode, gamesPlayed, categoryTotals)}</span></div>
                                    <div class="technique-item${eventTally.aerial.dair === 0 ? ' zero-value' : ''}">Down Air: <span>${formatValue(eventTally.aerial.dair, mode, gamesPlayed, categoryTotals)}</span></div>
                                </div>
                            </div>
                            ${canUseCharacterSpecials(playerSlot) ? `
                            <div class="sequence-category">
                                <h5>Character Specials - ${formatValue(characterSpecialsTotal, mode, gamesPlayed, categoryTotals)}</h5>
                                <div class="technique-grid">
                                    <div class="technique-item${eventTally.characterSpecials.phantasm === 0 ? ' zero-value' : ''}">Phantasm: <span>${formatValue(eventTally.characterSpecials.phantasm, mode, gamesPlayed, categoryTotals)}</span></div>
                                    <div class="technique-item${eventTally.characterSpecials.shine === 0 ? ' zero-value' : ''}">Shine: <span>${formatValue(eventTally.characterSpecials.shine, mode, gamesPlayed, categoryTotals)}</span></div>
                                    <div class="technique-item${eventTally.characterSpecials.laser === 0 ? ' zero-value' : ''}">Laser: <span>${formatValue(eventTally.characterSpecials.laser, mode, gamesPlayed, categoryTotals)}</span></div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="sequence-category full-width">
                            <h5>Other Sequences - ${formatValue(otherTotal, mode, gamesPlayed, categoryTotals)}</h5>
                            <div class="technique-grid-two-column">
                                <div class="technique-column">
                                    <div class="technique-item${eventTally.movement.land === 0 ? ' zero-value' : ''}">Land: <span>${formatValue(eventTally.movement.land, mode, gamesPlayed, categoryTotals)}</span></div>
                                    <div class="technique-item${eventTally.movement.jump === 0 ? ' zero-value' : ''}">Jump: <span>${formatValue(eventTally.movement.jump, mode, gamesPlayed, categoryTotals)}</span></div>
                                    <div class="technique-item${eventTally.damage.hit === 0 ? ' zero-value' : ''}">Hit: <span>${formatValue(eventTally.damage.hit, mode, gamesPlayed, categoryTotals)}</span></div>
                                </div>
                                <div class="technique-column">
                                    <div class="technique-item${eventTally.movement.grabEdge === 0 ? ' zero-value' : ''}">Grab Edge: <span>${formatValue(eventTally.movement.grabEdge, mode, gamesPlayed, categoryTotals)}</span></div>
                                    <div class="technique-item${eventTally.movement.waveLand === 0 ? ' zero-value' : ''}">Wave Land: <span>${formatValue(eventTally.movement.waveLand, mode, gamesPlayed, categoryTotals)}</span></div>
                                    <div class="technique-item${eventTally.movement.airDodge === 0 ? ' zero-value' : ''}">Air Dodge: <span>${formatValue(eventTally.movement.airDodge, mode, gamesPlayed, categoryTotals)}</span></div>
                                </div>
                                <div class="technique-item full-width-item${eventTally.other.timeout === 0 ? ' zero-value' : ''}">Other: <span>${formatValue(eventTally.other.timeout, mode, gamesPlayed, categoryTotals)}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        function createCancelTechniques(totals, playerSlot) {
            const cancelTechniques = [
                { key: 'edgeCancelCount', subKeys: ['nair', 'fair', 'bair', 'uair', 'dair'] },
                { key: 'teeterCancelCount', subKeys: ['nair', 'fair', 'bair', 'uair', 'dair'] },
                { key: 'autoCancelCount', subKeys: ['nair', 'fair', 'bair', 'uair', 'dair'] },
                { key: 'platformCancelCount', subKeys: ['nair', 'fair', 'bair', 'uair', 'dair'] }
            ];
            const categoryTotals = calculateCategoryTotals(totals, cancelTechniques);
            const mode = displayModes[`player${playerSlot}`]['cancel'];
            const gamesPlayed = playerDataSources[`player${playerSlot}`]?.playerData?.gamesPlayed || 1;

            return `
                <div class="category collapsible">
                    <h3 class="category-header">
                        <div class="category-header-text">
                            <span class="expand-icon">‚ñº</span>
                            Cancel Techniques
                        </div>
                        ${createDisplayToggles(playerSlot, 'cancel')}
                    </h3>
                    <div class="category-content">
                        <div class="cancel-section">
                            <h4>Edge Cancels - ${formatSubcategoryTotal(totals.edgeCancelCount || {}, ['nair', 'fair', 'bair', 'uair', 'dair'], mode, gamesPlayed, categoryTotals)}</h4>
                            <div class="aerial-grid">
                                <div class="technique-item uair${totals.edgeCancelCount.uair === 0 ? ' zero-value' : ''}">Up Air: <span>${formatValue(totals.edgeCancelCount.uair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item bair${totals.edgeCancelCount.bair === 0 ? ' zero-value' : ''}">Back Air: <span>${formatValue(totals.edgeCancelCount.bair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item nair${totals.edgeCancelCount.nair === 0 ? ' zero-value' : ''}">Neutral Air: <span>${formatValue(totals.edgeCancelCount.nair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item fair${totals.edgeCancelCount.fair === 0 ? ' zero-value' : ''}">Forward Air: <span>${formatValue(totals.edgeCancelCount.fair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item dair${totals.edgeCancelCount.dair === 0 ? ' zero-value' : ''}">Down Air: <span>${formatValue(totals.edgeCancelCount.dair, mode, gamesPlayed, categoryTotals)}</span></div>
                            </div>
                        </div>

                        <div class="cancel-section">
                            <h4>Teeter Cancels - ${formatSubcategoryTotal(totals.teeterCancelCount || {}, ['nair', 'fair', 'bair', 'uair', 'dair'], mode, gamesPlayed, categoryTotals)}</h4>
                            <div class="aerial-grid">
                                <div class="technique-item uair${totals.teeterCancelCount.uair === 0 ? ' zero-value' : ''}">Up Air: <span>${formatValue(totals.teeterCancelCount.uair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item bair${totals.teeterCancelCount.bair === 0 ? ' zero-value' : ''}">Back Air: <span>${formatValue(totals.teeterCancelCount.bair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item nair${totals.teeterCancelCount.nair === 0 ? ' zero-value' : ''}">Neutral Air: <span>${formatValue(totals.teeterCancelCount.nair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item fair${totals.teeterCancelCount.fair === 0 ? ' zero-value' : ''}">Forward Air: <span>${formatValue(totals.teeterCancelCount.fair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item dair${totals.teeterCancelCount.dair === 0 ? ' zero-value' : ''}">Down Air: <span>${formatValue(totals.teeterCancelCount.dair, mode, gamesPlayed, categoryTotals)}</span></div>
                            </div>
                        </div>

                        <div class="cancel-section">
                            <h4>Auto-Cancels - ${formatSubcategoryTotal(totals.autoCancelCount || {}, ['nair', 'fair', 'bair', 'uair', 'dair'], mode, gamesPlayed, categoryTotals)}</h4>
                            <div class="aerial-grid">
                                <div class="technique-item uair${totals.autoCancelCount.uair === 0 ? ' zero-value' : ''}">Up Air: <span>${formatValue(totals.autoCancelCount.uair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item bair${totals.autoCancelCount.bair === 0 ? ' zero-value' : ''}">Back Air: <span>${formatValue(totals.autoCancelCount.bair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item nair${totals.autoCancelCount.nair === 0 ? ' zero-value' : ''}">Neutral Air: <span>${formatValue(totals.autoCancelCount.nair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item fair${totals.autoCancelCount.fair === 0 ? ' zero-value' : ''}">Forward Air: <span>${formatValue(totals.autoCancelCount.fair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item dair${totals.autoCancelCount.dair === 0 ? ' zero-value' : ''}">Down Air: <span>${formatValue(totals.autoCancelCount.dair, mode, gamesPlayed, categoryTotals)}</span></div>
                            </div>
                        </div>

                        <div class="cancel-section">
                            <h4>Platform Cancels - ${formatSubcategoryTotal(totals.platformCancelCount || {}, ['nair', 'fair', 'bair', 'uair', 'dair'], mode, gamesPlayed, categoryTotals)}</h4>
                            <div class="aerial-grid">
                                <div class="technique-item uair${totals.platformCancelCount.uair === 0 ? ' zero-value' : ''}">Up Air: <span>${formatValue(totals.platformCancelCount.uair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item bair${totals.platformCancelCount.bair === 0 ? ' zero-value' : ''}">Back Air: <span>${formatValue(totals.platformCancelCount.bair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item nair${totals.platformCancelCount.nair === 0 ? ' zero-value' : ''}">Neutral Air: <span>${formatValue(totals.platformCancelCount.nair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item fair${totals.platformCancelCount.fair === 0 ? ' zero-value' : ''}">Forward Air: <span>${formatValue(totals.platformCancelCount.fair, mode, gamesPlayed, categoryTotals)}</span></div>
                                <div class="technique-item dair${totals.platformCancelCount.dair === 0 ? ' zero-value' : ''}">Down Air: <span>${formatValue(totals.platformCancelCount.dair, mode, gamesPlayed, categoryTotals)}</span></div>
                            </div>
                        </div>

                    </div>
                </div>
            `;
        }


        // Handle collapsible category toggle
        function handleCategoryToggle(event) {
            const target = event.target;
            
            // Don't handle clicks on toggle buttons or their children - be very specific
            if (target.classList.contains('toggle-button') || 
                target.closest('.toggle-button') ||
                target.closest('.display-toggles')) {
                // Let the button handle its own click
                return;
            }
            
            // Only handle clicks specifically on the expand icon or category title text
            // Exclude the entire category-header area to avoid conflicts
            if (target.classList.contains('expand-icon')) {
                // Find the category element
                let category = target.closest('.category.collapsible');
                if (!category) return;
                
                // Toggle collapsed state
                category.classList.toggle('collapsed');
                
                // Update icon
                const icon = category.querySelector('.expand-icon');
                if (icon) {
                    icon.textContent = category.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
                }
                
                event.stopPropagation();
            }
            // Also allow clicking on category text but not the entire header
            else if (target.textContent && (
                target.textContent.includes('Attack Statistics') ||
                target.textContent.includes('Specials Statistics') ||
                target.textContent.includes('Basic Techniques') ||
                target.textContent.includes('Platform Movement') ||
                target.textContent.includes('Shine Movement') ||
                target.textContent.includes('Cancel Techniques'))) {
                
                let category = target.closest('.category.collapsible');
                if (!category) return;
                
                // Toggle collapsed state
                category.classList.toggle('collapsed');
                
                // Update icon
                const icon = category.querySelector('.expand-icon');
                if (icon) {
                    icon.textContent = category.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
                }
                
                event.stopPropagation();
            }
        }

        // Embedded data to avoid CORS issues
const embeddedData = {
  "filesProcessed": 178,
  "totalFiles": 178,
  "failedFiles": [],
  "players": {
    "BBB#960": {
      "stages": {
        "battlefield": {
          "matchCount": 45,
          "wavedashCount": 679,
          "wavelandCount": 665,
          "lCancelCount": 1017,
          "dashDanceCount": 927,
          "ledgegrabCount": 297,
          "rollCount": 302,
          "airDodgeCount": -171,
          "spotDodgeCount": 122,
          "shieldDropCount": 300,
          "platformDropCount": 137,
          "runOffCount": 394,
          "wavelandOffCount": 193,
          "shineWavedashCount": {
            "framePerfect": 16,
            "framePerfectTurn": 0,
            "regular": 199,
            "regularTurn": 2,
            "total": 217
          },
          "shineWavelandCount": {
            "regular": 288,
            "turn": 9,
            "total": 297
          },
          "shineGrabCount": {
            "framePerfect": 3,
            "framePerfectTurn": 0,
            "regular": 0,
            "regularTurn": 0,
            "total": 3
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 5,
          "edgeCancelCount": {
            "dair": 23,
            "uair": 4,
            "bair": 11,
            "fair": 7,
            "nair": 8,
            "total": 53
          },
          "teeterCancelCount": {
            "dair": 2,
            "uair": 3,
            "bair": 0,
            "fair": 2,
            "nair": 0,
            "total": 7
          },
          "autoCancelCount": {
            "dair": 113,
            "uair": 15,
            "bair": 279,
            "fair": 1,
            "nair": 11,
            "total": 419
          },
          "noImpactLandingCount": 1,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 0,
            "fair": 0,
            "nair": 0,
            "total": 0
          },
          "attackCount": {
            "jab1": 40,
            "jab2": 8,
            "jab3": 0,
            "jabm": 0,
            "dash": 50,
            "ftilt": 66,
            "utilt": 156,
            "dtilt": 20,
            "fsmash": 54,
            "usmash": 15,
            "dsmash": 37,
            "nair": 300,
            "fair": 70,
            "bair": 605,
            "uair": 55,
            "dair": 837
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 300,
              "groundResolution": {
                "lCancelSuccess": 228,
                "lCancelFail": 24,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 11,
                "platformCancel": 0
              },
              "aerialTransition": 7,
              "recoveryTransition": 0,
              "hitOut": 30,
              "death": 0,
              "other": 0
            },
            "fair": {
              "total": 70,
              "groundResolution": {
                "lCancelSuccess": 48,
                "lCancelFail": 14,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 1,
                "platformCancel": 0
              },
              "aerialTransition": 1,
              "recoveryTransition": 0,
              "hitOut": 5,
              "death": 1,
              "other": 0
            },
            "bair": {
              "total": 605,
              "groundResolution": {
                "lCancelSuccess": 161,
                "lCancelFail": 49,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 279,
                "platformCancel": 0
              },
              "aerialTransition": 37,
              "recoveryTransition": 1,
              "hitOut": 69,
              "death": 9,
              "other": 0
            },
            "uair": {
              "total": 55,
              "groundResolution": {
                "lCancelSuccess": 25,
                "lCancelFail": 7,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 15,
                "platformCancel": 0
              },
              "aerialTransition": 2,
              "recoveryTransition": 0,
              "hitOut": 5,
              "death": 1,
              "other": 0
            },
            "dair": {
              "total": 837,
              "groundResolution": {
                "lCancelSuccess": 555,
                "lCancelFail": 68,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 113,
                "platformCancel": 0
              },
              "aerialTransition": 12,
              "recoveryTransition": 0,
              "hitOut": 81,
              "death": 5,
              "other": 0
            }
          }
        },
        "dream_land": {
          "matchCount": 15,
          "wavedashCount": 276,
          "wavelandCount": 172,
          "lCancelCount": 327,
          "dashDanceCount": 368,
          "ledgegrabCount": 98,
          "rollCount": 110,
          "airDodgeCount": -59,
          "spotDodgeCount": 43,
          "shieldDropCount": 64,
          "platformDropCount": 31,
          "runOffCount": 132,
          "wavelandOffCount": 62,
          "shineWavedashCount": {
            "framePerfect": 7,
            "framePerfectTurn": 0,
            "regular": 97,
            "regularTurn": 0,
            "total": 104
          },
          "shineWavelandCount": {
            "regular": 72,
            "turn": 9,
            "total": 81
          },
          "shineGrabCount": {
            "framePerfect": 4,
            "framePerfectTurn": 0,
            "regular": 0,
            "regularTurn": 0,
            "total": 4
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 2,
          "edgeCancelCount": {
            "dair": 3,
            "uair": 2,
            "bair": 4,
            "fair": 1,
            "nair": 2,
            "total": 12
          },
          "teeterCancelCount": {
            "dair": 1,
            "uair": 0,
            "bair": 0,
            "fair": 1,
            "nair": 0,
            "total": 2
          },
          "autoCancelCount": {
            "dair": 37,
            "uair": 8,
            "bair": 92,
            "fair": 1,
            "nair": 1,
            "total": 139
          },
          "noImpactLandingCount": 1,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 1,
            "fair": 0,
            "nair": 0,
            "total": 1
          },
          "attackCount": {
            "jab1": 19,
            "jab2": 3,
            "jab3": 0,
            "jabm": 0,
            "dash": 12,
            "ftilt": 14,
            "utilt": 37,
            "dtilt": 4,
            "fsmash": 17,
            "usmash": 6,
            "dsmash": 7,
            "nair": 92,
            "fair": 21,
            "bair": 189,
            "uair": 29,
            "dair": 262
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 92,
              "groundResolution": {
                "lCancelSuccess": 73,
                "lCancelFail": 6,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 1,
                "platformCancel": 0
              },
              "aerialTransition": 2,
              "recoveryTransition": 0,
              "hitOut": 9,
              "death": 1,
              "other": 0
            },
            "fair": {
              "total": 21,
              "groundResolution": {
                "lCancelSuccess": 13,
                "lCancelFail": 4,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 1,
                "platformCancel": 0
              },
              "aerialTransition": 0,
              "recoveryTransition": 0,
              "hitOut": 3,
              "death": 0,
              "other": 0
            },
            "bair": {
              "total": 188,
              "groundResolution": {
                "lCancelSuccess": 49,
                "lCancelFail": 11,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 92,
                "platformCancel": 0
              },
              "aerialTransition": 14,
              "recoveryTransition": 0,
              "hitOut": 20,
              "death": 2,
              "other": 0
            },
            "uair": {
              "total": 29,
              "groundResolution": {
                "lCancelSuccess": 14,
                "lCancelFail": 5,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 8,
                "platformCancel": 0
              },
              "aerialTransition": 1,
              "recoveryTransition": 0,
              "hitOut": 1,
              "death": 0,
              "other": 0
            },
            "dair": {
              "total": 262,
              "groundResolution": {
                "lCancelSuccess": 178,
                "lCancelFail": 17,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 37,
                "platformCancel": 0
              },
              "aerialTransition": 5,
              "recoveryTransition": 0,
              "hitOut": 24,
              "death": 0,
              "other": 0
            }
          }
        },
        "final_destination": {
          "matchCount": 14,
          "wavedashCount": 335,
          "wavelandCount": 46,
          "lCancelCount": 213,
          "dashDanceCount": 253,
          "ledgegrabCount": 94,
          "rollCount": 98,
          "airDodgeCount": -47,
          "spotDodgeCount": 23,
          "shieldDropCount": 0,
          "platformDropCount": 0,
          "runOffCount": 17,
          "wavelandOffCount": 19,
          "shineWavedashCount": {
            "framePerfect": 9,
            "framePerfectTurn": 0,
            "regular": 115,
            "regularTurn": 0,
            "total": 124
          },
          "shineWavelandCount": {
            "regular": 25,
            "turn": 0,
            "total": 25
          },
          "shineGrabCount": {
            "framePerfect": 0,
            "framePerfectTurn": 0,
            "regular": 0,
            "regularTurn": 0,
            "total": 0
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 5,
          "edgeCancelCount": {
            "dair": 2,
            "uair": 0,
            "bair": 0,
            "fair": 1,
            "nair": 0,
            "total": 3
          },
          "teeterCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 0,
            "fair": 1,
            "nair": 0,
            "total": 1
          },
          "autoCancelCount": {
            "dair": 13,
            "uair": 4,
            "bair": 44,
            "fair": 1,
            "nair": 1,
            "total": 63
          },
          "noImpactLandingCount": 0,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 0,
            "fair": 0,
            "nair": 0,
            "total": 0
          },
          "attackCount": {
            "jab1": 17,
            "jab2": 3,
            "jab3": 0,
            "jabm": 0,
            "dash": 16,
            "ftilt": 12,
            "utilt": 32,
            "dtilt": 4,
            "fsmash": 7,
            "usmash": 2,
            "dsmash": 5,
            "nair": 64,
            "fair": 15,
            "bair": 101,
            "uair": 27,
            "dair": 160
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 64,
              "groundResolution": {
                "lCancelSuccess": 46,
                "lCancelFail": 4,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 1,
                "platformCancel": 0
              },
              "aerialTransition": 7,
              "recoveryTransition": 0,
              "hitOut": 5,
              "death": 1,
              "other": 0
            },
            "fair": {
              "total": 15,
              "groundResolution": {
                "lCancelSuccess": 8,
                "lCancelFail": 3,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 1,
                "platformCancel": 0
              },
              "aerialTransition": 0,
              "recoveryTransition": 0,
              "hitOut": 2,
              "death": 1,
              "other": 0
            },
            "bair": {
              "total": 98,
              "groundResolution": {
                "lCancelSuccess": 20,
                "lCancelFail": 2,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 44,
                "platformCancel": 0
              },
              "aerialTransition": 19,
              "recoveryTransition": 0,
              "hitOut": 11,
              "death": 2,
              "other": 0
            },
            "uair": {
              "total": 27,
              "groundResolution": {
                "lCancelSuccess": 19,
                "lCancelFail": 1,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 4,
                "platformCancel": 0
              },
              "aerialTransition": 1,
              "recoveryTransition": 1,
              "hitOut": 0,
              "death": 1,
              "other": 0
            },
            "dair": {
              "total": 160,
              "groundResolution": {
                "lCancelSuccess": 120,
                "lCancelFail": 6,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 13,
                "platformCancel": 0
              },
              "aerialTransition": 2,
              "recoveryTransition": 0,
              "hitOut": 16,
              "death": 2,
              "other": 0
            }
          }
        },
        "fountain_of_dreams": {
          "matchCount": 12,
          "wavedashCount": 234,
          "wavelandCount": 105,
          "lCancelCount": 244,
          "dashDanceCount": 359,
          "ledgegrabCount": 73,
          "rollCount": 67,
          "airDodgeCount": -32,
          "spotDodgeCount": 30,
          "shieldDropCount": 38,
          "platformDropCount": 14,
          "runOffCount": 93,
          "wavelandOffCount": 36,
          "shineWavedashCount": {
            "framePerfect": 2,
            "framePerfectTurn": 0,
            "regular": 56,
            "regularTurn": 0,
            "total": 58
          },
          "shineWavelandCount": {
            "regular": 47,
            "turn": 0,
            "total": 47
          },
          "shineGrabCount": {
            "framePerfect": 0,
            "framePerfectTurn": 0,
            "regular": 0,
            "regularTurn": 0,
            "total": 0
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 2,
          "edgeCancelCount": {
            "dair": 8,
            "uair": 1,
            "bair": 0,
            "fair": 3,
            "nair": 1,
            "total": 13
          },
          "teeterCancelCount": {
            "dair": 1,
            "uair": 0,
            "bair": 0,
            "fair": 2,
            "nair": 2,
            "total": 5
          },
          "autoCancelCount": {
            "dair": 27,
            "uair": 3,
            "bair": 61,
            "fair": 1,
            "nair": 1,
            "total": 93
          },
          "noImpactLandingCount": 2,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 0,
            "fair": 0,
            "nair": 0,
            "total": 0
          },
          "attackCount": {
            "jab1": 13,
            "jab2": 2,
            "jab3": 0,
            "jabm": 0,
            "dash": 11,
            "ftilt": 11,
            "utilt": 44,
            "dtilt": 3,
            "fsmash": 15,
            "usmash": 3,
            "dsmash": 8,
            "nair": 65,
            "fair": 15,
            "bair": 141,
            "uair": 14,
            "dair": 221
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 65,
              "groundResolution": {
                "lCancelSuccess": 49,
                "lCancelFail": 7,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 1,
                "platformCancel": 0
              },
              "aerialTransition": 0,
              "recoveryTransition": 0,
              "hitOut": 8,
              "death": 0,
              "other": 0
            },
            "fair": {
              "total": 15,
              "groundResolution": {
                "lCancelSuccess": 8,
                "lCancelFail": 4,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 1,
                "platformCancel": 0
              },
              "aerialTransition": 0,
              "recoveryTransition": 0,
              "hitOut": 2,
              "death": 0,
              "other": 0
            },
            "bair": {
              "total": 141,
              "groundResolution": {
                "lCancelSuccess": 44,
                "lCancelFail": 10,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 61,
                "platformCancel": 0
              },
              "aerialTransition": 8,
              "recoveryTransition": 0,
              "hitOut": 15,
              "death": 2,
              "other": 1
            },
            "uair": {
              "total": 14,
              "groundResolution": {
                "lCancelSuccess": 7,
                "lCancelFail": 1,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 3,
                "platformCancel": 0
              },
              "aerialTransition": 1,
              "recoveryTransition": 0,
              "hitOut": 2,
              "death": 0,
              "other": 0
            },
            "dair": {
              "total": 221,
              "groundResolution": {
                "lCancelSuccess": 136,
                "lCancelFail": 34,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 27,
                "platformCancel": 0
              },
              "aerialTransition": 3,
              "recoveryTransition": 0,
              "hitOut": 21,
              "death": 0,
              "other": 0
            }
          }
        },
        "pokemon_stadium": {
          "matchCount": 31,
          "wavedashCount": 526,
          "wavelandCount": 284,
          "lCancelCount": 641,
          "dashDanceCount": 500,
          "ledgegrabCount": 162,
          "rollCount": 218,
          "airDodgeCount": -129,
          "spotDodgeCount": 61,
          "shieldDropCount": 41,
          "platformDropCount": 35,
          "runOffCount": 165,
          "wavelandOffCount": 70,
          "shineWavedashCount": {
            "framePerfect": 5,
            "framePerfectTurn": 0,
            "regular": 189,
            "regularTurn": 0,
            "total": 194
          },
          "shineWavelandCount": {
            "regular": 135,
            "turn": 2,
            "total": 137
          },
          "shineGrabCount": {
            "framePerfect": 2,
            "framePerfectTurn": 0,
            "regular": 0,
            "regularTurn": 0,
            "total": 2
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 0,
          "edgeCancelCount": {
            "dair": 5,
            "uair": 0,
            "bair": 2,
            "fair": 4,
            "nair": 4,
            "total": 15
          },
          "teeterCancelCount": {
            "dair": 3,
            "uair": 0,
            "bair": 0,
            "fair": 0,
            "nair": 1,
            "total": 4
          },
          "autoCancelCount": {
            "dair": 57,
            "uair": 10,
            "bair": 168,
            "fair": 4,
            "nair": 6,
            "total": 245
          },
          "noImpactLandingCount": 0,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 0,
            "fair": 0,
            "nair": 0,
            "total": 0
          },
          "attackCount": {
            "jab1": 36,
            "jab2": 3,
            "jab3": 0,
            "jabm": 0,
            "dash": 31,
            "ftilt": 44,
            "utilt": 110,
            "dtilt": 11,
            "fsmash": 32,
            "usmash": 12,
            "dsmash": 18,
            "nair": 177,
            "fair": 57,
            "bair": 345,
            "uair": 55,
            "dair": 531
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 177,
              "groundResolution": {
                "lCancelSuccess": 125,
                "lCancelFail": 11,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 6,
                "platformCancel": 0
              },
              "aerialTransition": 4,
              "recoveryTransition": 0,
              "hitOut": 29,
              "death": 2,
              "other": 0
            },
            "fair": {
              "total": 57,
              "groundResolution": {
                "lCancelSuccess": 40,
                "lCancelFail": 8,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 4,
                "platformCancel": 0
              },
              "aerialTransition": 0,
              "recoveryTransition": 0,
              "hitOut": 4,
              "death": 1,
              "other": 0
            },
            "bair": {
              "total": 345,
              "groundResolution": {
                "lCancelSuccess": 85,
                "lCancelFail": 22,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 168,
                "platformCancel": 0
              },
              "aerialTransition": 29,
              "recoveryTransition": 0,
              "hitOut": 38,
              "death": 1,
              "other": 1
            },
            "uair": {
              "total": 55,
              "groundResolution": {
                "lCancelSuccess": 33,
                "lCancelFail": 3,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 10,
                "platformCancel": 0
              },
              "aerialTransition": 7,
              "recoveryTransition": 0,
              "hitOut": 1,
              "death": 1,
              "other": 0
            },
            "dair": {
              "total": 531,
              "groundResolution": {
                "lCancelSuccess": 358,
                "lCancelFail": 39,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 57,
                "platformCancel": 0
              },
              "aerialTransition": 7,
              "recoveryTransition": 0,
              "hitOut": 68,
              "death": 2,
              "other": 0
            }
          }
        },
        "yoshis_story": {
          "matchCount": 61,
          "wavedashCount": 880,
          "wavelandCount": 921,
          "lCancelCount": 1379,
          "dashDanceCount": 1483,
          "ledgegrabCount": 540,
          "rollCount": 321,
          "airDodgeCount": -286,
          "spotDodgeCount": 158,
          "shieldDropCount": 318,
          "platformDropCount": 88,
          "runOffCount": 479,
          "wavelandOffCount": 288,
          "shineWavedashCount": {
            "framePerfect": 17,
            "framePerfectTurn": 0,
            "regular": 286,
            "regularTurn": 0,
            "total": 303
          },
          "shineWavelandCount": {
            "regular": 337,
            "turn": 107,
            "total": 444
          },
          "shineGrabCount": {
            "framePerfect": 8,
            "framePerfectTurn": 0,
            "regular": 1,
            "regularTurn": 0,
            "total": 9
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 22,
          "edgeCancelCount": {
            "dair": 24,
            "uair": 0,
            "bair": 2,
            "fair": 5,
            "nair": 11,
            "total": 42
          },
          "teeterCancelCount": {
            "dair": 5,
            "uair": 0,
            "bair": 2,
            "fair": 3,
            "nair": 4,
            "total": 14
          },
          "autoCancelCount": {
            "dair": 130,
            "uair": 16,
            "bair": 344,
            "fair": 5,
            "nair": 7,
            "total": 502
          },
          "noImpactLandingCount": 2,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 4,
            "fair": 0,
            "nair": 0,
            "total": 4
          },
          "attackCount": {
            "jab1": 65,
            "jab2": 18,
            "jab3": 0,
            "jabm": 2,
            "dash": 48,
            "ftilt": 49,
            "utilt": 204,
            "dtilt": 23,
            "fsmash": 69,
            "usmash": 26,
            "dsmash": 41,
            "nair": 346,
            "fair": 79,
            "bair": 773,
            "uair": 69,
            "dair": 1183
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 346,
              "groundResolution": {
                "lCancelSuccess": 257,
                "lCancelFail": 26,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 7,
                "platformCancel": 0
              },
              "aerialTransition": 11,
              "recoveryTransition": 0,
              "hitOut": 45,
              "death": 0,
              "other": 0
            },
            "fair": {
              "total": 79,
              "groundResolution": {
                "lCancelSuccess": 53,
                "lCancelFail": 8,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 5,
                "platformCancel": 0
              },
              "aerialTransition": 1,
              "recoveryTransition": 0,
              "hitOut": 9,
              "death": 3,
              "other": 0
            },
            "bair": {
              "total": 773,
              "groundResolution": {
                "lCancelSuccess": 235,
                "lCancelFail": 51,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 344,
                "platformCancel": 0
              },
              "aerialTransition": 51,
              "recoveryTransition": 0,
              "hitOut": 87,
              "death": 2,
              "other": 3
            },
            "uair": {
              "total": 69,
              "groundResolution": {
                "lCancelSuccess": 32,
                "lCancelFail": 5,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 16,
                "platformCancel": 0
              },
              "aerialTransition": 9,
              "recoveryTransition": 1,
              "hitOut": 5,
              "death": 1,
              "other": 0
            },
            "dair": {
              "total": 1183,
              "groundResolution": {
                "lCancelSuccess": 802,
                "lCancelFail": 123,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 130,
                "platformCancel": 0
              },
              "aerialTransition": 19,
              "recoveryTransition": 1,
              "hitOut": 100,
              "death": 4,
              "other": 0
            }
          }
        },
        "all": {
          "matchCount": 178,
          "wavedashCount": 2930,
          "wavelandCount": 2193,
          "lCancelCount": 3821,
          "dashDanceCount": 3890,
          "ledgegrabCount": 1264,
          "rollCount": 1116,
          "airDodgeCount": -724,
          "spotDodgeCount": 437,
          "shieldDropCount": 761,
          "platformDropCount": 305,
          "runOffCount": 1280,
          "wavelandOffCount": 668,
          "shineWavedashCount": {
            "framePerfect": 56,
            "framePerfectTurn": 0,
            "regular": 942,
            "regularTurn": 2,
            "total": 1000
          },
          "shineWavelandCount": {
            "regular": 904,
            "turn": 127,
            "total": 1031
          },
          "shineGrabCount": {
            "framePerfect": 17,
            "framePerfectTurn": 0,
            "regular": 1,
            "regularTurn": 0,
            "total": 18
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 36,
          "edgeCancelCount": {
            "dair": 65,
            "uair": 7,
            "bair": 19,
            "fair": 21,
            "nair": 26,
            "total": 138
          },
          "teeterCancelCount": {
            "dair": 12,
            "uair": 3,
            "bair": 2,
            "fair": 9,
            "nair": 7,
            "total": 33
          },
          "autoCancelCount": {
            "dair": 377,
            "uair": 56,
            "bair": 988,
            "fair": 13,
            "nair": 27,
            "total": 1461
          },
          "noImpactLandingCount": 6,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 5,
            "fair": 0,
            "nair": 0,
            "total": 5
          },
          "attackCount": {
            "jab1": 190,
            "jab2": 37,
            "jab3": 0,
            "jabm": 2,
            "dash": 168,
            "ftilt": 196,
            "utilt": 583,
            "dtilt": 65,
            "fsmash": 194,
            "usmash": 64,
            "dsmash": 116,
            "nair": 1044,
            "fair": 257,
            "bair": 2154,
            "uair": 249,
            "dair": 3194
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 1044,
              "groundResolution": {
                "lCancelSuccess": 778,
                "lCancelFail": 78,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 27,
                "platformCancel": 0
              },
              "aerialTransition": 31,
              "recoveryTransition": 0,
              "hitOut": 126,
              "death": 4,
              "other": 0
            },
            "fair": {
              "total": 257,
              "groundResolution": {
                "lCancelSuccess": 170,
                "lCancelFail": 41,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 13,
                "platformCancel": 0
              },
              "aerialTransition": 2,
              "recoveryTransition": 0,
              "hitOut": 25,
              "death": 6,
              "other": 0
            },
            "bair": {
              "total": 2150,
              "groundResolution": {
                "lCancelSuccess": 594,
                "lCancelFail": 145,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 988,
                "platformCancel": 0
              },
              "aerialTransition": 158,
              "recoveryTransition": 1,
              "hitOut": 240,
              "death": 18,
              "other": 5
            },
            "uair": {
              "total": 249,
              "groundResolution": {
                "lCancelSuccess": 130,
                "lCancelFail": 22,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 56,
                "platformCancel": 0
              },
              "aerialTransition": 21,
              "recoveryTransition": 2,
              "hitOut": 14,
              "death": 4,
              "other": 0
            },
            "dair": {
              "total": 3194,
              "groundResolution": {
                "lCancelSuccess": 2149,
                "lCancelFail": 287,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 377,
                "platformCancel": 0
              },
              "aerialTransition": 48,
              "recoveryTransition": 1,
              "hitOut": 310,
              "death": 13,
              "other": 0
            }
          }
        }
      },
      "gamesPlayed": 178
    },
    "MANG#0": {
      "stages": {
        "battlefield": {
          "matchCount": 45,
          "wavedashCount": 813,
          "wavelandCount": 371,
          "lCancelCount": 1263,
          "dashDanceCount": 605,
          "ledgegrabCount": 254,
          "rollCount": 85,
          "airDodgeCount": -65,
          "spotDodgeCount": 27,
          "shieldDropCount": 376,
          "platformDropCount": 41,
          "runOffCount": 273,
          "wavelandOffCount": 104,
          "shineWavedashCount": {
            "framePerfect": 1,
            "framePerfectTurn": 0,
            "regular": 176,
            "regularTurn": 0,
            "total": 177
          },
          "shineWavelandCount": {
            "regular": 157,
            "turn": 1,
            "total": 158
          },
          "shineGrabCount": {
            "framePerfect": 0,
            "framePerfectTurn": 0,
            "regular": 0,
            "regularTurn": 0,
            "total": 0
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 13,
          "edgeCancelCount": {
            "dair": 4,
            "uair": 3,
            "bair": 0,
            "fair": 0,
            "nair": 2,
            "total": 9
          },
          "teeterCancelCount": {
            "dair": 6,
            "uair": 0,
            "bair": 1,
            "fair": 0,
            "nair": 1,
            "total": 8
          },
          "autoCancelCount": {
            "dair": 95,
            "uair": 15,
            "bair": 394,
            "fair": 1,
            "nair": 6,
            "total": 511
          },
          "noImpactLandingCount": 7,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 2,
            "fair": 0,
            "nair": 0,
            "total": 2
          },
          "attackCount": {
            "jab1": 81,
            "jab2": 3,
            "jab3": 0,
            "jabm": 0,
            "dash": 17,
            "ftilt": 35,
            "utilt": 54,
            "dtilt": 50,
            "fsmash": 40,
            "usmash": 39,
            "dsmash": 23,
            "nair": 362,
            "fair": 73,
            "bair": 883,
            "uair": 62,
            "dair": 791
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 362,
              "groundResolution": {
                "lCancelSuccess": 295,
                "lCancelFail": 14,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 6,
                "platformCancel": 0
              },
              "aerialTransition": 6,
              "recoveryTransition": 0,
              "hitOut": 41,
              "death": 0,
              "other": 0
            },
            "fair": {
              "total": 73,
              "groundResolution": {
                "lCancelSuccess": 52,
                "lCancelFail": 12,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 1,
                "platformCancel": 0
              },
              "aerialTransition": 0,
              "recoveryTransition": 0,
              "hitOut": 7,
              "death": 1,
              "other": 0
            },
            "bair": {
              "total": 883,
              "groundResolution": {
                "lCancelSuccess": 306,
                "lCancelFail": 48,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 394,
                "platformCancel": 0
              },
              "aerialTransition": 36,
              "recoveryTransition": 0,
              "hitOut": 98,
              "death": 1,
              "other": 0
            },
            "uair": {
              "total": 62,
              "groundResolution": {
                "lCancelSuccess": 33,
                "lCancelFail": 8,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 15,
                "platformCancel": 0
              },
              "aerialTransition": 3,
              "recoveryTransition": 0,
              "hitOut": 3,
              "death": 0,
              "other": 0
            },
            "dair": {
              "total": 791,
              "groundResolution": {
                "lCancelSuccess": 577,
                "lCancelFail": 42,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 95,
                "platformCancel": 0
              },
              "aerialTransition": 6,
              "recoveryTransition": 0,
              "hitOut": 69,
              "death": 0,
              "other": 0
            }
          }
        },
        "dream_land": {
          "matchCount": 15,
          "wavedashCount": 332,
          "wavelandCount": 70,
          "lCancelCount": 361,
          "dashDanceCount": 181,
          "ledgegrabCount": 73,
          "rollCount": 29,
          "airDodgeCount": -29,
          "spotDodgeCount": 9,
          "shieldDropCount": 81,
          "platformDropCount": 9,
          "runOffCount": 77,
          "wavelandOffCount": 34,
          "shineWavedashCount": {
            "framePerfect": 1,
            "framePerfectTurn": 0,
            "regular": 71,
            "regularTurn": 0,
            "total": 72
          },
          "shineWavelandCount": {
            "regular": 35,
            "turn": 0,
            "total": 35
          },
          "shineGrabCount": {
            "framePerfect": 0,
            "framePerfectTurn": 0,
            "regular": 0,
            "regularTurn": 0,
            "total": 0
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 7,
          "edgeCancelCount": {
            "dair": 3,
            "uair": 0,
            "bair": 2,
            "fair": 0,
            "nair": 0,
            "total": 5
          },
          "teeterCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 0,
            "fair": 0,
            "nair": 0,
            "total": 0
          },
          "autoCancelCount": {
            "dair": 36,
            "uair": 3,
            "bair": 121,
            "fair": 0,
            "nair": 3,
            "total": 163
          },
          "noImpactLandingCount": 2,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 0,
            "fair": 0,
            "nair": 0,
            "total": 0
          },
          "attackCount": {
            "jab1": 30,
            "jab2": 5,
            "jab3": 0,
            "jabm": 1,
            "dash": 3,
            "ftilt": 10,
            "utilt": 14,
            "dtilt": 18,
            "fsmash": 21,
            "usmash": 15,
            "dsmash": 7,
            "nair": 109,
            "fair": 27,
            "bair": 272,
            "uair": 15,
            "dair": 229
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 109,
              "groundResolution": {
                "lCancelSuccess": 91,
                "lCancelFail": 3,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 3,
                "platformCancel": 0
              },
              "aerialTransition": 1,
              "recoveryTransition": 0,
              "hitOut": 11,
              "death": 0,
              "other": 0
            },
            "fair": {
              "total": 27,
              "groundResolution": {
                "lCancelSuccess": 16,
                "lCancelFail": 6,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 0,
                "platformCancel": 0
              },
              "aerialTransition": 3,
              "recoveryTransition": 0,
              "hitOut": 2,
              "death": 0,
              "other": 0
            },
            "bair": {
              "total": 272,
              "groundResolution": {
                "lCancelSuccess": 99,
                "lCancelFail": 13,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 121,
                "platformCancel": 0
              },
              "aerialTransition": 8,
              "recoveryTransition": 0,
              "hitOut": 30,
              "death": 0,
              "other": 1
            },
            "uair": {
              "total": 15,
              "groundResolution": {
                "lCancelSuccess": 7,
                "lCancelFail": 0,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 3,
                "platformCancel": 0
              },
              "aerialTransition": 3,
              "recoveryTransition": 0,
              "hitOut": 2,
              "death": 0,
              "other": 0
            },
            "dair": {
              "total": 229,
              "groundResolution": {
                "lCancelSuccess": 148,
                "lCancelFail": 26,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 36,
                "platformCancel": 0
              },
              "aerialTransition": 0,
              "recoveryTransition": 0,
              "hitOut": 18,
              "death": 0,
              "other": 0
            }
          }
        },
        "final_destination": {
          "matchCount": 14,
          "wavedashCount": 278,
          "wavelandCount": 16,
          "lCancelCount": 288,
          "dashDanceCount": 158,
          "ledgegrabCount": 62,
          "rollCount": 32,
          "airDodgeCount": -28,
          "spotDodgeCount": 5,
          "shieldDropCount": 0,
          "platformDropCount": 0,
          "runOffCount": 40,
          "wavelandOffCount": 14,
          "shineWavedashCount": {
            "framePerfect": 1,
            "framePerfectTurn": 0,
            "regular": 96,
            "regularTurn": 0,
            "total": 97
          },
          "shineWavelandCount": {
            "regular": 8,
            "turn": 0,
            "total": 8
          },
          "shineGrabCount": {
            "framePerfect": 0,
            "framePerfectTurn": 0,
            "regular": 0,
            "regularTurn": 0,
            "total": 0
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 3,
          "edgeCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 2,
            "fair": 1,
            "nair": 2,
            "total": 5
          },
          "teeterCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 0,
            "fair": 0,
            "nair": 1,
            "total": 1
          },
          "autoCancelCount": {
            "dair": 19,
            "uair": 1,
            "bair": 78,
            "fair": 0,
            "nair": 2,
            "total": 100
          },
          "noImpactLandingCount": 0,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 0,
            "fair": 0,
            "nair": 0,
            "total": 0
          },
          "attackCount": {
            "jab1": 24,
            "jab2": 1,
            "jab3": 0,
            "jabm": 0,
            "dash": 4,
            "ftilt": 13,
            "utilt": 18,
            "dtilt": 13,
            "fsmash": 23,
            "usmash": 8,
            "dsmash": 8,
            "nair": 101,
            "fair": 11,
            "bair": 150,
            "uair": 14,
            "dair": 200
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 101,
              "groundResolution": {
                "lCancelSuccess": 88,
                "lCancelFail": 2,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 2,
                "platformCancel": 0
              },
              "aerialTransition": 3,
              "recoveryTransition": 0,
              "hitOut": 6,
              "death": 0,
              "other": 0
            },
            "fair": {
              "total": 11,
              "groundResolution": {
                "lCancelSuccess": 7,
                "lCancelFail": 1,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 0,
                "platformCancel": 0
              },
              "aerialTransition": 0,
              "recoveryTransition": 0,
              "hitOut": 2,
              "death": 1,
              "other": 0
            },
            "bair": {
              "total": 150,
              "groundResolution": {
                "lCancelSuccess": 31,
                "lCancelFail": 5,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 78,
                "platformCancel": 0
              },
              "aerialTransition": 21,
              "recoveryTransition": 1,
              "hitOut": 13,
              "death": 0,
              "other": 1
            },
            "uair": {
              "total": 14,
              "groundResolution": {
                "lCancelSuccess": 12,
                "lCancelFail": 0,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 1,
                "platformCancel": 0
              },
              "aerialTransition": 1,
              "recoveryTransition": 0,
              "hitOut": 0,
              "death": 0,
              "other": 0
            },
            "dair": {
              "total": 200,
              "groundResolution": {
                "lCancelSuccess": 150,
                "lCancelFail": 11,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 19,
                "platformCancel": 0
              },
              "aerialTransition": 2,
              "recoveryTransition": 1,
              "hitOut": 15,
              "death": 0,
              "other": 0
            }
          }
        },
        "fountain_of_dreams": {
          "matchCount": 12,
          "wavedashCount": 234,
          "wavelandCount": 36,
          "lCancelCount": 308,
          "dashDanceCount": 204,
          "ledgegrabCount": 57,
          "rollCount": 30,
          "airDodgeCount": -7,
          "spotDodgeCount": 7,
          "shieldDropCount": 62,
          "platformDropCount": 4,
          "runOffCount": 81,
          "wavelandOffCount": 26,
          "shineWavedashCount": {
            "framePerfect": 0,
            "framePerfectTurn": 0,
            "regular": 51,
            "regularTurn": 0,
            "total": 51
          },
          "shineWavelandCount": {
            "regular": 13,
            "turn": 0,
            "total": 13
          },
          "shineGrabCount": {
            "framePerfect": 0,
            "framePerfectTurn": 0,
            "regular": 1,
            "regularTurn": 0,
            "total": 1
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 4,
          "edgeCancelCount": {
            "dair": 1,
            "uair": 0,
            "bair": 1,
            "fair": 0,
            "nair": 1,
            "total": 3
          },
          "teeterCancelCount": {
            "dair": 1,
            "uair": 0,
            "bair": 0,
            "fair": 0,
            "nair": 0,
            "total": 1
          },
          "autoCancelCount": {
            "dair": 29,
            "uair": 0,
            "bair": 93,
            "fair": 1,
            "nair": 2,
            "total": 125
          },
          "noImpactLandingCount": 1,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 0,
            "fair": 0,
            "nair": 0,
            "total": 0
          },
          "attackCount": {
            "jab1": 13,
            "jab2": 0,
            "jab3": 0,
            "jabm": 0,
            "dash": 7,
            "ftilt": 12,
            "utilt": 25,
            "dtilt": 12,
            "fsmash": 14,
            "usmash": 15,
            "dsmash": 9,
            "nair": 97,
            "fair": 17,
            "bair": 201,
            "uair": 5,
            "dair": 216
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 97,
              "groundResolution": {
                "lCancelSuccess": 81,
                "lCancelFail": 5,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 2,
                "platformCancel": 0
              },
              "aerialTransition": 0,
              "recoveryTransition": 0,
              "hitOut": 9,
              "death": 0,
              "other": 0
            },
            "fair": {
              "total": 17,
              "groundResolution": {
                "lCancelSuccess": 15,
                "lCancelFail": 0,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 1,
                "platformCancel": 0
              },
              "aerialTransition": 0,
              "recoveryTransition": 0,
              "hitOut": 0,
              "death": 1,
              "other": 0
            },
            "bair": {
              "total": 201,
              "groundResolution": {
                "lCancelSuccess": 58,
                "lCancelFail": 10,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 93,
                "platformCancel": 0
              },
              "aerialTransition": 9,
              "recoveryTransition": 1,
              "hitOut": 29,
              "death": 0,
              "other": 1
            },
            "uair": {
              "total": 5,
              "groundResolution": {
                "lCancelSuccess": 5,
                "lCancelFail": 0,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 0,
                "platformCancel": 0
              },
              "aerialTransition": 0,
              "recoveryTransition": 0,
              "hitOut": 0,
              "death": 0,
              "other": 0
            },
            "dair": {
              "total": 216,
              "groundResolution": {
                "lCancelSuccess": 149,
                "lCancelFail": 19,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 29,
                "platformCancel": 0
              },
              "aerialTransition": 2,
              "recoveryTransition": 0,
              "hitOut": 13,
              "death": 0,
              "other": 1
            }
          }
        },
        "pokemon_stadium": {
          "matchCount": 31,
          "wavedashCount": 639,
          "wavelandCount": 95,
          "lCancelCount": 768,
          "dashDanceCount": 337,
          "ledgegrabCount": 142,
          "rollCount": 104,
          "airDodgeCount": -50,
          "spotDodgeCount": 10,
          "shieldDropCount": 83,
          "platformDropCount": 4,
          "runOffCount": 106,
          "wavelandOffCount": 52,
          "shineWavedashCount": {
            "framePerfect": 4,
            "framePerfectTurn": 0,
            "regular": 169,
            "regularTurn": 0,
            "total": 173
          },
          "shineWavelandCount": {
            "regular": 54,
            "turn": 0,
            "total": 54
          },
          "shineGrabCount": {
            "framePerfect": 2,
            "framePerfectTurn": 0,
            "regular": 1,
            "regularTurn": 0,
            "total": 3
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 5,
          "edgeCancelCount": {
            "dair": 1,
            "uair": 0,
            "bair": 0,
            "fair": 3,
            "nair": 2,
            "total": 6
          },
          "teeterCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 0,
            "fair": 1,
            "nair": 3,
            "total": 4
          },
          "autoCancelCount": {
            "dair": 65,
            "uair": 6,
            "bair": 232,
            "fair": 0,
            "nair": 15,
            "total": 318
          },
          "noImpactLandingCount": 0,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 0,
            "fair": 0,
            "nair": 0,
            "total": 0
          },
          "attackCount": {
            "jab1": 57,
            "jab2": 0,
            "jab3": 0,
            "jabm": 0,
            "dash": 11,
            "ftilt": 19,
            "utilt": 48,
            "dtilt": 62,
            "fsmash": 57,
            "usmash": 30,
            "dsmash": 8,
            "nair": 247,
            "fair": 45,
            "bair": 488,
            "uair": 68,
            "dair": 508
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 247,
              "groundResolution": {
                "lCancelSuccess": 190,
                "lCancelFail": 14,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 15,
                "platformCancel": 0
              },
              "aerialTransition": 4,
              "recoveryTransition": 0,
              "hitOut": 24,
              "death": 0,
              "other": 0
            },
            "fair": {
              "total": 45,
              "groundResolution": {
                "lCancelSuccess": 30,
                "lCancelFail": 8,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 0,
                "platformCancel": 0
              },
              "aerialTransition": 1,
              "recoveryTransition": 0,
              "hitOut": 6,
              "death": 0,
              "other": 0
            },
            "bair": {
              "total": 487,
              "groundResolution": {
                "lCancelSuccess": 135,
                "lCancelFail": 16,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 232,
                "platformCancel": 0
              },
              "aerialTransition": 50,
              "recoveryTransition": 0,
              "hitOut": 53,
              "death": 0,
              "other": 1
            },
            "uair": {
              "total": 68,
              "groundResolution": {
                "lCancelSuccess": 50,
                "lCancelFail": 5,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 6,
                "platformCancel": 0
              },
              "aerialTransition": 5,
              "recoveryTransition": 0,
              "hitOut": 2,
              "death": 0,
              "other": 0
            },
            "dair": {
              "total": 508,
              "groundResolution": {
                "lCancelSuccess": 363,
                "lCancelFail": 30,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 65,
                "platformCancel": 0
              },
              "aerialTransition": 6,
              "recoveryTransition": 0,
              "hitOut": 35,
              "death": 3,
              "other": 0
            }
          }
        },
        "yoshis_story": {
          "matchCount": 61,
          "wavedashCount": 1178,
          "wavelandCount": 443,
          "lCancelCount": 1455,
          "dashDanceCount": 924,
          "ledgegrabCount": 507,
          "rollCount": 127,
          "airDodgeCount": -78,
          "spotDodgeCount": 30,
          "shieldDropCount": 361,
          "platformDropCount": 47,
          "runOffCount": 405,
          "wavelandOffCount": 133,
          "shineWavedashCount": {
            "framePerfect": 4,
            "framePerfectTurn": 0,
            "regular": 269,
            "regularTurn": 0,
            "total": 273
          },
          "shineWavelandCount": {
            "regular": 153,
            "turn": 0,
            "total": 153
          },
          "shineGrabCount": {
            "framePerfect": 1,
            "framePerfectTurn": 0,
            "regular": 0,
            "regularTurn": 0,
            "total": 1
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 77,
          "edgeCancelCount": {
            "dair": 5,
            "uair": 0,
            "bair": 4,
            "fair": 3,
            "nair": 1,
            "total": 13
          },
          "teeterCancelCount": {
            "dair": 3,
            "uair": 0,
            "bair": 0,
            "fair": 1,
            "nair": 4,
            "total": 8
          },
          "autoCancelCount": {
            "dair": 109,
            "uair": 21,
            "bair": 528,
            "fair": 0,
            "nair": 9,
            "total": 667
          },
          "noImpactLandingCount": 4,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 5,
            "fair": 0,
            "nair": 0,
            "total": 5
          },
          "attackCount": {
            "jab1": 76,
            "jab2": 2,
            "jab3": 0,
            "jabm": 0,
            "dash": 13,
            "ftilt": 50,
            "utilt": 83,
            "dtilt": 71,
            "fsmash": 69,
            "usmash": 64,
            "dsmash": 32,
            "nair": 390,
            "fair": 67,
            "bair": 1079,
            "uair": 99,
            "dair": 1021
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 390,
              "groundResolution": {
                "lCancelSuccess": 304,
                "lCancelFail": 21,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 9,
                "platformCancel": 0
              },
              "aerialTransition": 10,
              "recoveryTransition": 0,
              "hitOut": 45,
              "death": 1,
              "other": 0
            },
            "fair": {
              "total": 67,
              "groundResolution": {
                "lCancelSuccess": 47,
                "lCancelFail": 9,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 0,
                "platformCancel": 0
              },
              "aerialTransition": 1,
              "recoveryTransition": 1,
              "hitOut": 8,
              "death": 1,
              "other": 0
            },
            "bair": {
              "total": 1078,
              "groundResolution": {
                "lCancelSuccess": 302,
                "lCancelFail": 53,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 528,
                "platformCancel": 0
              },
              "aerialTransition": 62,
              "recoveryTransition": 2,
              "hitOut": 125,
              "death": 2,
              "other": 3
            },
            "uair": {
              "total": 99,
              "groundResolution": {
                "lCancelSuccess": 59,
                "lCancelFail": 3,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 21,
                "platformCancel": 0
              },
              "aerialTransition": 10,
              "recoveryTransition": 0,
              "hitOut": 6,
              "death": 0,
              "other": 0
            },
            "dair": {
              "total": 1021,
              "groundResolution": {
                "lCancelSuccess": 743,
                "lCancelFail": 71,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 109,
                "platformCancel": 0
              },
              "aerialTransition": 11,
              "recoveryTransition": 0,
              "hitOut": 75,
              "death": 6,
              "other": 3
            }
          }
        },
        "all": {
          "matchCount": 178,
          "wavedashCount": 3474,
          "wavelandCount": 1031,
          "lCancelCount": 4443,
          "dashDanceCount": 2409,
          "ledgegrabCount": 1095,
          "rollCount": 407,
          "airDodgeCount": -257,
          "spotDodgeCount": 88,
          "shieldDropCount": 963,
          "platformDropCount": 105,
          "runOffCount": 982,
          "wavelandOffCount": 363,
          "shineWavedashCount": {
            "framePerfect": 11,
            "framePerfectTurn": 0,
            "regular": 832,
            "regularTurn": 0,
            "total": 843
          },
          "shineWavelandCount": {
            "regular": 420,
            "turn": 1,
            "total": 421
          },
          "shineGrabCount": {
            "framePerfect": 3,
            "framePerfectTurn": 0,
            "regular": 2,
            "regularTurn": 0,
            "total": 5
          },
          "shineTurnaroundFirefoxLedgeGrabCount": 109,
          "edgeCancelCount": {
            "dair": 14,
            "uair": 3,
            "bair": 9,
            "fair": 7,
            "nair": 8,
            "total": 41
          },
          "teeterCancelCount": {
            "dair": 10,
            "uair": 0,
            "bair": 1,
            "fair": 2,
            "nair": 9,
            "total": 22
          },
          "autoCancelCount": {
            "dair": 353,
            "uair": 46,
            "bair": 1446,
            "fair": 2,
            "nair": 37,
            "total": 1884
          },
          "noImpactLandingCount": 14,
          "platformCancelCount": {
            "dair": 0,
            "uair": 0,
            "bair": 7,
            "fair": 0,
            "nair": 0,
            "total": 7
          },
          "attackCount": {
            "jab1": 281,
            "jab2": 11,
            "jab3": 0,
            "jabm": 1,
            "dash": 55,
            "ftilt": 139,
            "utilt": 242,
            "dtilt": 226,
            "fsmash": 224,
            "usmash": 171,
            "dsmash": 87,
            "nair": 1306,
            "fair": 240,
            "bair": 3073,
            "uair": 263,
            "dair": 2965
          },
          "aerialResolutionCount": {
            "nair": {
              "total": 1306,
              "groundResolution": {
                "lCancelSuccess": 1049,
                "lCancelFail": 59,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 37,
                "platformCancel": 0
              },
              "aerialTransition": 24,
              "recoveryTransition": 0,
              "hitOut": 136,
              "death": 1,
              "other": 0
            },
            "fair": {
              "total": 240,
              "groundResolution": {
                "lCancelSuccess": 167,
                "lCancelFail": 36,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 2,
                "platformCancel": 0
              },
              "aerialTransition": 5,
              "recoveryTransition": 1,
              "hitOut": 25,
              "death": 4,
              "other": 0
            },
            "bair": {
              "total": 3071,
              "groundResolution": {
                "lCancelSuccess": 931,
                "lCancelFail": 145,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 1446,
                "platformCancel": 0
              },
              "aerialTransition": 186,
              "recoveryTransition": 4,
              "hitOut": 348,
              "death": 3,
              "other": 7
            },
            "uair": {
              "total": 263,
              "groundResolution": {
                "lCancelSuccess": 166,
                "lCancelFail": 16,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 46,
                "platformCancel": 0
              },
              "aerialTransition": 22,
              "recoveryTransition": 0,
              "hitOut": 13,
              "death": 0,
              "other": 0
            },
            "dair": {
              "total": 2965,
              "groundResolution": {
                "lCancelSuccess": 2130,
                "lCancelFail": 199,
                "edgeCancel": 0,
                "teeterCancel": 0,
                "autoCancel": 353,
                "platformCancel": 0
              },
              "aerialTransition": 27,
              "recoveryTransition": 1,
              "hitOut": 225,
              "death": 9,
              "other": 4
            }
          }
        }
      },
      "gamesPlayed": 178
    }
  }
};

// Handle aerial tab switching
function setupAerialTabs() {
    const aerialTabs = document.querySelectorAll('.aerial-tab');
    
    aerialTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            const aerialType = tab.dataset.aerial;
            const playerSection = tab.closest('.player-section');
            
            // Remove active class from all tabs in this player section
            const allTabs = playerSection.querySelectorAll('.aerial-tab');
            const allPanels = playerSection.querySelectorAll('.aerial-panel');
            
            allTabs.forEach(t => t.classList.remove('active'));
            allPanels.forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding panel
            tab.classList.add('active');
            const panel = playerSection.querySelector(`.aerial-panel[data-aerial="${aerialType}"]`);
            if (panel) {
                panel.classList.add('active');
            }
        });
    });
}

// Handle smash tab switching
function setupSmashTabs() {
    const smashTabs = document.querySelectorAll('.smash-tab');
    
    smashTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            const smashType = tab.dataset.smash;
            const playerSection = tab.closest('.player-section');
            
            // Remove active class from all tabs in this player section
            const allTabs = playerSection.querySelectorAll('.smash-tab');
            const allPanels = playerSection.querySelectorAll('.smash-panel');
            
            allTabs.forEach(t => t.classList.remove('active'));
            allPanels.forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding panel
            tab.classList.add('active');
            const activePanel = playerSection.querySelector(`.smash-panel[data-smash="${smashType}"]`);
            if (activePanel) {
                activePanel.classList.add('active');
            }
        });
    });
}

// Handle platform movement tab switching
function setupPlatformTabs() {
    const platformTabs = document.querySelectorAll('.platform-tab');
    
    platformTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            const platformType = tab.dataset.platform;
            const playerSection = tab.closest('.player-section');
            
            // Remove active class from all tabs in this player section
            const allTabs = playerSection.querySelectorAll('.platform-tab');
            const allPanels = playerSection.querySelectorAll('.platform-sequence-panel');
            
            allTabs.forEach(t => t.classList.remove('active'));
            allPanels.forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding panel
            tab.classList.add('active');
            const panel = playerSection.querySelector(`.platform-sequence-panel[data-platform="${platformType}"]`);
            if (panel) {
                panel.classList.add('active');
            }
        });
    });
}

function setupLaserTabs() {
    const laserTabs = document.querySelectorAll('.laser-tab');
    
    laserTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            const laserType = tab.dataset.laser;
            const playerSection = tab.closest('.player-section');
            
            // Remove active class from all tabs in this player section
            const allTabs = playerSection.querySelectorAll('.laser-tab');
            const allPanels = playerSection.querySelectorAll('.laser-panel');
            
            allTabs.forEach(t => t.classList.remove('active'));
            allPanels.forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding panel
            tab.classList.add('active');
            const panel = playerSection.querySelector(`.laser-panel[data-laser="${laserType}"]`);
            if (panel) {
                panel.classList.add('active');
            }
        });
    });
}

// Handle phantasm tab switching
function setupPhantasmTabs() {
    const phantasmTabs = document.querySelectorAll('.firefox-tab[data-phantasm]');
    
    phantasmTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            const phantasmType = tab.dataset.phantasm;
            const playerSection = tab.closest('.player-section');
            
            // Remove active class from all phantasm tabs in this player section
            const allTabs = playerSection.querySelectorAll('.firefox-tab[data-phantasm]');
            const allPanels = playerSection.querySelectorAll('.firefox-panel[data-phantasm]');
            
            allTabs.forEach(t => t.classList.remove('active'));
            allPanels.forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding panel
            tab.classList.add('active');
            const panel = playerSection.querySelector(`.firefox-panel[data-phantasm="${phantasmType}"]`);
            if (panel) {
                panel.classList.add('active');
            }
        });
    });
}

function setupFirefoxTabs() {
    const firefoxTabs = document.querySelectorAll('.firefox-tab[data-firefox]');
    
    firefoxTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            const firefoxType = tab.dataset.firefox;
            const playerSection = tab.closest('.player-section');
            
            // Remove active class from all firefox tabs in this player section
            const allTabs = playerSection.querySelectorAll('.firefox-tab[data-firefox]');
            const allPanels = playerSection.querySelectorAll('.firefox-panel[data-firefox]');
            
            allTabs.forEach(t => t.classList.remove('active'));
            allPanels.forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding panel
            tab.classList.add('active');
            const panel = playerSection.querySelector(`.firefox-panel[data-firefox="${firefoxType}"]`);
            if (panel) {
                panel.classList.add('active');
            }
        });
    });
}

// Handle display toggle button clicks
function setupDisplayToggleButtons() {
    const toggleButtons = document.querySelectorAll('.toggle-button[data-player][data-category][data-mode]');
    
    toggleButtons.forEach(button => {
        // Remove any existing listeners to avoid duplicates
        button.removeEventListener('click', handleToggleClick);
        button.addEventListener('click', handleToggleClick);
    });
}

function handleToggleClick(event) {
    event.stopPropagation(); // Prevent category collapse
    
    const button = event.target;
    const playerSlot = parseInt(button.dataset.player);
    const categoryId = button.dataset.category;
    const mode = button.dataset.mode;
    
    console.log(`Toggle clicked: player${playerSlot}, ${categoryId}, ${mode}`);
    setDisplayMode(playerSlot, categoryId, mode);
}

// Initialize comparison interface when page loads
window.addEventListener('DOMContentLoaded', () => {
    
    // Initialize with comparison display (empty state)
    updateComparisonDisplay();
    
    // Set initial summary
    document.getElementById('files-processed').textContent = 'Ready for comparison';
    document.getElementById('failed-files').textContent = 'Load player data above to begin';
    
    // Ensure attacks view is also populated with placeholders
    updateAttacksDisplay();
});

// View switching functionality
let currentView = 'movement';

function switchView(viewName) {
    const movementContainer = document.getElementById('movement-container');
    const attacksContainer = document.getElementById('attacks-container');
    const conversionsContainer = document.getElementById('conversions-container');
    const movementBtn = document.getElementById('movement-view-btn');
    const attacksBtn = document.getElementById('attacks-view-btn');
    const conversionsBtn = document.getElementById('conversions-view-btn');
    
    // Hide all containers
    movementContainer.style.display = 'none';
    attacksContainer.style.display = 'none';
    conversionsContainer.style.display = 'none';
    
    // Remove active class from all buttons
    movementBtn.classList.remove('active');
    attacksBtn.classList.remove('active');
    conversionsBtn.classList.remove('active');
    
    if (viewName === 'movement') {
        movementContainer.style.display = 'grid';
        movementBtn.classList.add('active');
        currentView = 'movement';
    } else if (viewName === 'attacks') {
        attacksContainer.style.display = 'grid';
        attacksBtn.classList.add('active');
        currentView = 'attacks';
        // If using comparison mode, attacks should already be populated
        // If no comparison data, populate with placeholders
        if (attacksContainer.children.length === 0) {
            updateAttacksDisplay();
        }
    } else if (viewName === 'conversions') {
        conversionsContainer.style.display = 'grid';
        conversionsBtn.classList.add('active');
        currentView = 'conversions';
        updateConversionsDisplay();
    }
}

// Conversion data storage
let conversionData = {
    player1: null,
    player2: null
};

// Load conversion data for a player
async function loadConversionData(playerSlot) {
    if (!playerDataSources[`player${playerSlot}`]) {
        return null;
    }
    
    const playerData = playerDataSources[`player${playerSlot}`];
    const playerStats = playerData.playerData;
    
    
    if (!playerStats || !playerStats.stages) {
        return {
            playerName: playerData.playerName,
            connectCode: playerData.connectCode,
            totalConversions: 0,
            conversions: []
        };
    }
    
    // Stage filtering removed - using all stages
    const playerKey = `player${playerSlot}`;
    let aggregatedConversions = [];
    let totalStats = {
        totalConversions: 0,
        killConversions: 0,
        totalDamage: 0,
        averageDamage: 0,
        longestConversion: 0,
        highestDamageConversion: 0
    };
    
    // Aggregate conversion data from selected stages
    
    activeStages.forEach(stage => {
        const stageData = playerStats.stages[stage];
        
        if (stageData && stageData.combos) {
            totalStats.totalConversions += stageData.combos.totalCombos || 0;
            totalStats.killConversions += stageData.combos.killCombos || 0;
            totalStats.totalDamage += stageData.combos.totalDamage || 0;
            
            if ((stageData.combos.longestCombo || 0) > totalStats.longestConversion) {
                totalStats.longestConversion = stageData.combos.longestCombo;
            }
            if ((stageData.combos.highestDamageCombo || 0) > totalStats.highestDamageConversion) {
                totalStats.highestDamageConversion = stageData.combos.highestDamageCombo;
            }
            
            // Add individual conversions from this stage
            if (stageData.combos.comboList && Array.isArray(stageData.combos.comboList)) {
                aggregatedConversions.push(...stageData.combos.comboList);
            }
        }
    });
    
    // Calculate average damage
    if (totalStats.totalConversions > 0) {
        totalStats.averageDamage = Math.round((totalStats.totalDamage / totalStats.totalConversions) * 100) / 100;
    }
    
    // Sort conversions by start time (most recent first) and limit to 100 for performance
    aggregatedConversions.sort((a, b) => (b.startFrame || 0) - (a.startFrame || 0));
    if (aggregatedConversions.length > 100) {
        aggregatedConversions = aggregatedConversions.slice(0, 100);
    }
    
    return {
        playerName: playerData.playerName,
        connectCode: playerData.connectCode,
        totalConversions: totalStats.totalConversions,
        killConversions: totalStats.killConversions,
        averageDamage: totalStats.averageDamage,
        longestConversion: totalStats.longestConversion,
        highestDamageConversion: totalStats.highestDamageConversion,
        conversions: aggregatedConversions
    };
}

// Update conversions display
async function updateConversionsDisplay() {
    const conversionsContainer = document.getElementById('conversions-container');
    conversionsContainer.innerHTML = '';
    
    // Load conversion data for both players if available
    if (playerDataSources.player1) {
        conversionData.player1 = await loadConversionData(1);
    }
    if (playerDataSources.player2) {
        conversionData.player2 = await loadConversionData(2);
    }
    
    if (!conversionData.player1 && !conversionData.player2) {
        conversionsContainer.innerHTML = `
            <div class="conversion-placeholder">
                <h3>üîÑ Conversion Analysis</h3>
                <p>Load player data from the Data Source Selection above to view conversion analysis.</p>
                <p><em>Note: Conversion data requires running the updated read-replays-simple.js script to generate results.json with conversion data.</em></p>
            </div>
        `;
    } else {
        // Display each player if data is available using side-by-side layout
        [1, 2].forEach(playerSlot => {
            const playerKey = `player${playerSlot}`;
            const playerData = conversionData[playerKey];
            
            if (playerData) {
                const playerSection = createConversionPlayerSection(playerData, playerSlot);
                conversionsContainer.appendChild(playerSection);
            } else {
                // Show placeholder if no data loaded
                const placeholderSection = document.createElement('section');
                placeholderSection.className = 'player-section';
                placeholderSection.innerHTML = `
                    <h2>PLAYER ${playerSlot}</h2>
                    <div class="no-data">No conversion data loaded. Use the controls above to load player data.</div>
                `;
                conversionsContainer.appendChild(placeholderSection);
            }
        });
    }
}

// Update attacks display with attack-only player sections
function updateAttacksDisplay() {
    const attacksContainer = document.getElementById('attacks-container');
    attacksContainer.innerHTML = '';

    // Update summary to show attacks mode
    document.getElementById('files-processed').textContent = 'Attacks Analysis Mode';
    document.getElementById('failed-files').textContent = 'Showing attack statistics only';

    // Display each player if data is available
    [1, 2].forEach(playerSlot => {
        const playerKey = `player${playerSlot}`;
        const playerSource = playerDataSources[playerKey];
        
        if (playerSource && playerSource.playerData) {
            const aggregatedData = aggregateStageData(playerSource.playerData.stages, null);
            
            const playerSection = createAttackPlayerSection(playerSource.connectCode, aggregatedData, playerSlot);
            attacksContainer.appendChild(playerSection);
        } else {
            // Show placeholder if no data loaded
            const placeholderSection = document.createElement('section');
            placeholderSection.className = 'player-section';
            placeholderSection.innerHTML = `
                <h2>PLAYER ${playerSlot}</h2>
                <div class="no-data">No data loaded. Use the controls above to load player data.</div>
            `;
            attacksContainer.appendChild(placeholderSection);
        }
    });
    
    // Setup aerial tabs after all player sections are added
    setupAerialTabs();
    
    // Setup smash tabs
    setupSmashTabs();
    
    // Setup phantasm tabs
    setupPhantasmTabs();
    
    // Setup display toggle buttons
    setupDisplayToggleButtons();
    
}



// Create a conversion player section matching movement analysis style
function createConversionPlayerSection(playerConversions, playerSlot) {
    const section = document.createElement('section');
    section.className = 'player-section';
    
    section.innerHTML = `
        <h2>${(playerConversions.playerName || playerConversions.connectCode).toUpperCase()}</h2>
        
        <div class="technique-categories">
            ${createConversionStatistics(playerConversions, playerSlot)}
            ${createConversionBreakdowns(playerConversions, playerSlot)}
        </div>
    `;
    
    // Add event listeners for collapsible categories
    section.addEventListener('click', handleCategoryToggle);
    
    return section;
}

// Create conversion statistics section matching Basic Techniques style
function createConversionStatistics(playerConversions, playerSlot) {
    return `
        <div class="category collapsible">
            <h3 class="category-header">
                <div class="category-header-text">
                    <span class="expand-icon">‚ñº</span>
                    Conversion Statistics
                </div>
            </h3>
            <div class="category-content">
                <div class="technique-grid">
                    <div class="technique-item${playerConversions.totalConversions === 0 ? ' zero-value' : ''}">Total Conversions: <span>${playerConversions.totalConversions}</span></div>
                    <div class="technique-item${(playerConversions.killConversions || 0) === 0 ? ' zero-value' : ''}">Kill Conversions: <span>${playerConversions.killConversions || 0}</span></div>
                    <div class="technique-item${(playerConversions.averageDamage || 0) === 0 ? ' zero-value' : ''}">Avg Damage: <span>${Math.floor(playerConversions.averageDamage || 0)}%</span></div>
                    <div class="technique-item${(playerConversions.longestConversion || 0) === 0 ? ' zero-value' : ''}">Longest: <span>${playerConversions.longestConversion || 0} moves</span></div>
                    <div class="technique-item${(playerConversions.highestDamageConversion || 0) === 0 ? ' zero-value' : ''}">Highest Damage: <span>${Math.floor(playerConversions.highestDamageConversion || 0)}%</span></div>
                </div>
            </div>
        </div>
    `;
}

// Create conversion breakdowns section with filters and scrollable container
function createConversionBreakdowns(playerConversions, playerSlot) {
    const playerKey = `player${playerSlot}`;
    // Stage filtering removed
    
    return `
        <div class="category collapsible">
            <h3 class="category-header">
                <div class="category-header-text">
                    <span class="expand-icon">‚ñº</span>
                    Conversion Breakdowns
                </div>
            </h3>
            <div class="category-content">
                <div class="conversion-filters">
                    <div class="filter-group">
                        <label>
                            Sort by: 
                            <select class="conversion-sort" data-player="${playerSlot}">
                                <option value="earliest">Earliest</option>
                                <option value="latest">Latest</option>
                                <option value="damage-high">Damage (High to Low)</option>
                                <option value="damage-low">Damage (Low to High)</option>
                                <option value="moves-high">Move Count (High to Low)</option>
                                <option value="moves-low">Move Count (Low to High)</option>
                                <option value="duration-high">Duration (Long to Short)</option>
                                <option value="duration-low">Duration (Short to Long)</option>
                            </select>
                        </label>
                    </div>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" class="conversion-filter" data-filter="kill-conversions" data-player="${playerSlot}">
                            Show only kill conversions
                        </label>
                    </div>
                    <div class="filter-group">
                        <label>
                            Min damage: <input type="number" class="conversion-filter-number" data-filter="min-damage" data-player="${playerSlot}" placeholder="0" min="0">
                        </label>
                    </div>
                    <div class="filter-group">
                        <label>
                            Min moves: <input type="number" class="conversion-filter-number" data-filter="min-moves" data-player="${playerSlot}" placeholder="0" min="0">
                        </label>
                    </div>
                </div>
                
                <div class="conversion-list" id="player${playerSlot}-conversion-list">
                    ${createConversionList(playerConversions.conversions, null, 'earliest')}
                </div>
            </div>
        </div>
    `;
}

// Helper function to get character-aware display names for states
function getDisplayStateName(originalName, actionStateId) {
    // For now, handle SpecialN -> Laser conversion for Falco
    // TODO: This could be enhanced to be character-aware when character data is available
    if (originalName === 'SpecialN' && actionStateId === 344) {
        return 'Laser'; // Assume Falco for now, could be enhanced later
    }
    return originalName;
}

// Create the list of conversions
function createConversionList(conversions, unusedStageFilters, sortBy = 'earliest') {
    if (!conversions || conversions.length === 0) {
        return `
            <div class="no-conversions">
                <p>No conversion data available</p>
                <p><em>Run the read-replays-simple.js script on replay files to generate conversion data.</em></p>
            </div>
        `;
    }
    
    // Filter conversions based on stage filters (when we have conversion data with stage info)
    let filteredConversions = [...conversions]; // Create a copy to avoid modifying original
    
    // Sort conversions based on the selected sort option
    filteredConversions.sort((a, b) => {
        switch (sortBy) {
            case 'earliest':
                return parseFloat(a.startTime) - parseFloat(b.startTime);
            case 'latest':
                return parseFloat(b.startTime) - parseFloat(a.startTime);
            case 'damage-high':
                return parseFloat(b.damage) - parseFloat(a.damage);
            case 'damage-low':
                return parseFloat(a.damage) - parseFloat(b.damage);
            case 'moves-high':
                return parseInt(b.moves) - parseInt(a.moves);
            case 'moves-low':
                return parseInt(a.moves) - parseInt(b.moves);
            case 'duration-high':
                return parseFloat(b.duration) - parseFloat(a.duration);
            case 'duration-low':
                return parseFloat(a.duration) - parseFloat(b.duration);
            default:
                return parseFloat(a.startTime) - parseFloat(b.startTime);
        }
    });
    
    // Helper function to format seconds to minutes:seconds
    function formatTime(timeInSeconds) {
        const totalSeconds = parseFloat(timeInSeconds);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = Math.floor(totalSeconds % 60);
        return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }


    return filteredConversions.map(conversion => createSummarizedConversionItem(conversion, formatTime)).join('');
}

// Create a summarized conversion item showing moves with damage
function createSummarizedConversionItem(conversion, formatTime) {
    // Use moves_detail data directly since stateSequence is no longer available
    const hitMoves = [];
    
    if (conversion.moves_detail && conversion.moves_detail.length > 0) {
        conversion.moves_detail.forEach(move => {
            if (move.damage > 0) {
                hitMoves.push({
                    name: move.attackName || `Move ${move.moveId}`,
                    damage: move.damage,
                    frame: move.frame
                });
            }
        });
    }
    
    const hits = hitMoves.length;
    const moves = conversion.moves || 0;
    
    const hitMovesDisplay = hitMoves.length > 0 
        ? hitMoves.map(move => `<div class="hit-cell">${move.name}<span class="hit-damage">+${Math.floor(move.damage)}%</span></div>`).join('')
        : '<div class="no-hits">No hit moves recorded</div>';
    
    return `
        <div class="conversion-item summarized-view ${conversion.didKill ? 'kill-conversion' : ''}" data-damage="${conversion.damage}" data-moves="${moves}">
            <div class="conversion-header">
                <div class="conversion-timing">
                    <span class="conversion-time">${formatTime(conversion.startTime)} - ${formatTime(conversion.endTime)} (${conversion.duration}s)</span>
                </div>
                ${conversion.didKill ? '<span class="kill-badge">üíÄ</span>' : ''}
            </div>
            <div class="conversion-stats">
                <div class="damage-line">
                    <span class="damage">+${Math.floor(conversion.damage)}%</span>
                    <span class="opponent">vs ${conversion.opponentName}</span>
                </div>
                <div class="attack-breakdown">
                    <span class="hits-stat">${hits} hits</span>
                    <span class="moves-stat">${moves} total moves</span>
                </div>
            </div>
            <div class="hit-moves">
                <h4>Hit Moves:</h4>
                <div class="hit-moves-list">
                    ${hitMovesDisplay}
                </div>
            </div>
        </div>
    `;
}

// Setup conversion filter event listeners
function setupConversionFilterListeners() {
    document.addEventListener('change', (e) => {
        if (e.target.classList.contains('conversion-filter') || e.target.classList.contains('conversion-filter-number')) {
            const playerSlot = e.target.dataset.player;
            filterConversions(playerSlot);
        } else if (e.target.classList.contains('conversion-sort')) {
            const playerSlot = e.target.dataset.player;
            sortConversions(playerSlot, e.target.value);
        }
    });
}

// Filter conversions based on active filters
function filterConversions(playerSlot) {
    const conversionList = document.getElementById(`player${playerSlot}-conversion-list`);
    const conversions = conversionList.querySelectorAll('.conversion-item');
    
    const killOnly = document.querySelector(`[data-filter="kill-conversions"][data-player="${playerSlot}"]`).checked;
    const minDamage = parseInt(document.querySelector(`[data-filter="min-damage"][data-player="${playerSlot}"]`).value) || 0;
    const minMoves = parseInt(document.querySelector(`[data-filter="min-moves"][data-player="${playerSlot}"]`).value) || 0;
    
    conversions.forEach(conversion => {
        const isKill = conversion.classList.contains('kill-conversion');
        const damage = parseInt(conversion.dataset.damage) || 0;
        const moves = parseInt(conversion.dataset.moves) || 0;
        
        const shouldShow = (!killOnly || isKill) && 
                          (damage >= minDamage) && 
                          (moves >= minMoves);
        
        conversion.style.display = shouldShow ? 'block' : 'none';
    });
}

// Sort conversions and re-render the list
function sortConversions(playerSlot, sortBy) {
    const playerKey = `player${playerSlot}`;
    const playerData = playerDataSources[playerKey];
    
    if (!playerData || !playerData.conversions) {
        return;
    }
    
    // Stage filtering removed
    
    // Re-render the conversion list with new sort order
    const conversionListElement = document.getElementById(`player${playerSlot}-conversion-list`);
    conversionListElement.innerHTML = createConversionList(playerData.conversions, null, sortBy);
    
    // Re-apply current filters after re-rendering
    setTimeout(() => filterConversions(playerSlot), 0);
}

// Initialize conversion filter listeners
setupConversionFilterListeners();

    </script>
</body>
</html>
